const { Storage } = require('@google-cloud/storage');
const { Datastore } = require('@google-cloud/datastore');
const fs = require('fs');
const path = require('path');

// Inicializace Google Cloud Storage s credentials pro p≈ô√≠stup k vernostkarty bucketu
const storage = new Storage({
  projectId: 'vernostkarty',  // Bucket vern ostni-certificates pat≈ô√≠ projektu vernostkarty
  keyFilename: './certificates/vernostkarty-firebase-adminsdk-2j135-d46f086885.json'  // Pou≈æijeme vernostkarty credentials
});
const bucketName = 'vernostni-certificates';

// Inicializace Datastore pro vernostkarty-db
const datastore = new Datastore({
  projectId: 'vernostkarty',
  keyFilename: './certificates/vernostkarty-db-service-account.json'
});

/**
 * Helper pro naƒç√≠t√°n√≠ Apple Wallet certifik√°t≈Ø podle prefixu
 * @param {string} prefix - 6-znakov√Ω prefix (nap≈ô. "000001", "123456")
 * @returns {Object} Objekt s cestami k certifik√°t≈Øm
 */
async function getAppleCertificatesByPrefix(prefix = null) {
  try {
    console.log(`üîê Naƒç√≠t√°m Apple Wallet certifik√°ty pro prefix: ${prefix || 'original'}`);
    
    const bucket = storage.bucket(bucketName);
    
    let folderPath, filePrefix;
    
    if (prefix) {
      // Pou≈æit√≠ prefixu - certifik√°ty jsou ve slo≈æce podle prefixu
      folderPath = `${prefix}/`;
      filePrefix = `${prefix}_`;
    } else {
      // Fallback na p≈Øvodn√≠ certifik√°ty
      folderPath = 'original/apple-wallet/';
      filePrefix = '';
    }
    
    // N√°zvy soubor≈Ø podle prefixu
    const certFiles = {
      passCert: `${folderPath}${filePrefix}passCert.pem`,
      privateKey: `${folderPath}${filePrefix}privatekey.key`,
      wwdrCert: `${folderPath}${filePrefix}AppleWWDRCAG4.pem`
    };
    
    // St√°hneme soubory do doƒçasn√© pamƒõti
    const tempDir = `/tmp/certificates_${prefix || 'original'}`;
    
    if (!fs.existsSync(tempDir)) {
      fs.mkdirSync(tempDir, { recursive: true });
    }
    
    const localPaths = {};
    
    // St√°hneme ka≈æd√Ω soubor
    for (const [key, cloudPath] of Object.entries(certFiles)) {
      try {
        const file = bucket.file(cloudPath);
        const localPath = path.join(tempDir, path.basename(cloudPath));
        
        console.log(`üì• Stahuji ${cloudPath} do ${localPath}`);
        await file.download({ destination: localPath });
        
        localPaths[key] = localPath;
      } catch (error) {
        console.error(`‚ùå Chyba p≈ôi stahov√°n√≠ ${cloudPath}:`, error.message);
        throw error;
      }
    }
    
    // Vr√°t√≠me cesty pro zpƒõtnou kompatibilitu
    return {
      wwdr: localPaths.wwdrCert,
      signerCert: localPaths.passCert,
      signerKey: localPaths.privateKey
    };
    
  } catch (error) {
    console.error(`‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ certifik√°t≈Ø pro prefix ${prefix}:`, error);
    
    // Fallback na lok√°ln√≠ soubory
    console.log('üîÑ Pou≈æ√≠v√°m lok√°ln√≠ certifik√°ty jako fallback...');
    return {
      wwdr: "./certificates/AppleWWDRCAG4.pem",
      signerCert: "./certificates/passCert.pem", 
      signerKey: "./certificates/privatekey.key"
    };
  }
}

/**
 * Helper pro naƒç√≠t√°n√≠ Firebase credentials podle prefixu
 * @param {string} credentialType - Typ credentials ('main', 'db', 'db-admin')
 * @param {string} prefix - 6-znakov√Ω prefix (voliteln√Ω)
 * @returns {Object} Naƒçten√© credentials
 */
async function getFirebaseCredentialsByPrefix(credentialType, prefix = null) {
  try {
    console.log(`üîê Naƒç√≠t√°m Firebase credentials (${credentialType}) pro prefix: ${prefix || 'original'}`);
    
    const bucket = storage.bucket(bucketName);
    
    let fileName;
    
    if (prefix) {
      // Pou≈æit√≠ prefixu - credentials jsou ve slo≈æce podle prefixu
      fileName = `${prefix}/${prefix}_credentials.json`;
    } else {
      // Fallback na p≈Øvodn√≠ credentials
      switch (credentialType) {
        case 'main':
          fileName = 'original/firebase-credentials/vernostkarty-firebase-adminsdk-2j135-d46f086885.json';
          break;
        case 'db':
          fileName = 'original/firebase-credentials/vernostkarty-db-service-account.json';
          break;
        case 'db-admin':
          fileName = 'original/firebase-credentials/vernostkarty-db-firebase-adminsdk-fbsvc-0585ca91cb.json';
          break;
        default:
          throw new Error(`Nezn√°m√Ω typ credentials: ${credentialType}`);
      }
    }
    
    const file = bucket.file(fileName);
    const [contents] = await file.download();
    
    return JSON.parse(contents.toString());
    
  } catch (error) {
    console.error(`‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ ${credentialType} credentials pro prefix ${prefix}:`, error);
    
    // Fallback na lok√°ln√≠ soubory
    console.log('üîÑ Pou≈æ√≠v√°m lok√°ln√≠ credentials jako fallback...');
    switch (credentialType) {
      case 'main':
        return require('./certificates/vernostkarty-firebase-adminsdk-2j135-d46f086885.json');
      case 'db':
        return require('./certificates/vernostkarty-db-service-account.json');
      case 'db-admin':
        return require('./certificates/vernostkarty-db-firebase-adminsdk-fbsvc-0585ca91cb.json');
      default:
        throw new Error(`Nezn√°m√Ω typ credentials: ${credentialType}`);
    }
  }
}

/**
 * Pomocn√° funkce pro extrakci prefixu z n√°zvu souboru nebo ID
 * @param {string} input - N√°zev souboru nebo ID (nap≈ô. "000001_passCert.pem" nebo "000001")
 * @returns {string} 6-znakov√Ω prefix
 */
function extractPrefix(input) {
  if (!input) return null;
  
  // Pokud u≈æ je to 6-znakov√Ω prefix
  if (input.length === 6 && /^\d{6}$/.test(input)) {
    return input;
  }
  
  // Extrakce z n√°zvu souboru (nap≈ô. "000001_passCert.pem" -> "000001")
  const match = input.match(/^(\d{6})_/);
  return match ? match[1] : null;
}

/**
 * Funkce pro nahr√°n√≠ nov√Ωch certifik√°t≈Ø s prefixem
 * @param {string} prefix - 6-znakov√Ω prefix
 * @param {Object} files - Objekt s cestami k lok√°ln√≠m soubor≈Øm
 */
async function uploadCertificatesWithPrefix(prefix, files) {
  try {
    console.log(`üì§ Nahr√°v√°m certifik√°ty pro prefix: ${prefix}`);
    
    const bucket = storage.bucket(bucketName);
    
    for (const [type, localPath] of Object.entries(files)) {
      if (!fs.existsSync(localPath)) {
        console.log(`‚ö†Ô∏è  Soubor ${localPath} neexistuje, p≈ôeskakuji...`);
        continue;
      }
      
      const fileName = path.basename(localPath);
      const prefixedFileName = fileName.startsWith(prefix) ? fileName : `${prefix}_${fileName}`;
      const cloudPath = `${prefix}/${prefixedFileName}`;
      
      console.log(`üì§ Nahr√°v√°m ${localPath} -> ${cloudPath}`);
      
      await bucket.upload(localPath, {
        destination: cloudPath,
        metadata: {
          cacheControl: 'no-cache',
        },
      });
      
      console.log(`‚úÖ ${cloudPath} nahr√°no.`);
    }
    
    console.log(`üéâ V≈°echny certifik√°ty pro prefix ${prefix} nahr√°ny!`);
    
  } catch (error) {
    console.error(`‚ùå Chyba p≈ôi nahr√°v√°n√≠ certifik√°t≈Ø pro prefix ${prefix}:`, error);
    throw error;
  }
}

/**
 * Naƒçte cesty k certifik√°t≈Øm podle cafeId z Datastore
 * @param {string} cafeId - ID kav√°rny
 * @returns {Object} Objekt s p12Path a wwdrPath
 */
async function getCertificatePathsByCafeId(cafeId) {
  try {
    console.log(`üîç Naƒç√≠t√°m cesty k certifik√°t≈Øm pro cafeId: ${cafeId}`);
    
    const key = datastore.key(['cardzapier', cafeId]);
    const [entity] = await datastore.get(key);
    
    if (!entity) {
      throw new Error(`Nenalezeny cesty k certifik√°t≈Øm pro cafeId: ${cafeId}`);
    }
    
    const { p12Path, wwdrPath } = entity;
    
    if (!p12Path || !wwdrPath) {
      throw new Error(`Ne√∫pln√© cesty k certifik√°t≈Øm pro cafeId: ${cafeId}`);
    }
    
    console.log(`‚úÖ Nalezeny cesty: p12Path=${p12Path}, wwdrPath=${wwdrPath}`);
    
    return { p12Path, wwdrPath };
    
  } catch (error) {
    console.error(`‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ cest k certifik√°t≈Øm pro cafeId ${cafeId}:`, error);
    throw error;
  }
}

/**
 * Naƒçte Apple Wallet certifik√°ty podle cafeId
 * @param {string} cafeId - ID kav√°rny
 * @returns {Object} Objekt s obsahem certifik√°t≈Ø (p12Buffer, wwdrBuffer)
 */
async function getAppleCertificatesByCafeId(cafeId) {
  try {
    console.log(`üîê Naƒç√≠t√°m Apple Wallet certifik√°ty pro cafeId: ${cafeId}`);
    
    // Naƒçteme cesty z Datastore
    const { p12Path, wwdrPath } = await getCertificatePathsByCafeId(cafeId);
    
    const bucket = storage.bucket(bucketName);
    
    // St√°hneme .p12 certifik√°t
    console.log(`üì• Stahov√°n√≠ .p12 certifik√°tu z: ${p12Path}`);
    const p12File = bucket.file(p12Path);
    const [p12Buffer] = await p12File.download();
    
    // St√°hneme WWDR certifik√°t
    console.log(`üì• Stahov√°n√≠ WWDR certifik√°tu z: ${wwdrPath}`);
    const wwdrFile = bucket.file(wwdrPath);
    const [wwdrBuffer] = await wwdrFile.download();
    
    console.log(`‚úÖ Certifik√°ty pro cafeId ${cafeId} √∫spƒõ≈°nƒõ naƒçteny`);
    
    return {
      p12Buffer,
      wwdrBuffer,
      p12Path,
      wwdrPath
    };
    
  } catch (error) {
    console.error(`‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ certifik√°t≈Ø pro cafeId ${cafeId}:`, error);
    
    // Fallback na original certifik√°ty
    console.log('üîÑ Pou≈æ√≠v√°m original certifik√°ty jako fallback...');
    try {
      const originalCerts = await getAppleCertificatesByPrefix(null);
      
      // P≈ôevedeme lok√°ln√≠ soubory na buffery
      const p12Buffer = fs.readFileSync(originalCerts.passCert);
      const wwdrBuffer = fs.readFileSync(originalCerts.wwdrCert);
      
      return {
        p12Buffer,
        wwdrBuffer,
        p12Path: 'fallback-local',
        wwdrPath: 'fallback-local'
      };
    } catch (fallbackError) {
      console.error('‚ùå Fallback tak√© selhal:', fallbackError);
      throw new Error(`Nelze naƒç√≠st certifik√°ty pro cafeId ${cafeId} ani fallback`);
    }
  }
}

module.exports = {
  getAppleCertificatesByPrefix,
  getFirebaseCredentialsByPrefix,
  extractPrefix,
  uploadCertificatesWithPrefix,
  getCertificatePathsByCafeId,
  getAppleCertificatesByCafeId,
  
  // Zpƒõtn√° kompatibilita - p≈Øvodn√≠ funkce pou≈æ√≠vaj√≠ prefix null (= original)
  getAppleCertificatePaths: () => getAppleCertificatesByPrefix(null),
  getFirebaseCredentials: (type) => getFirebaseCredentialsByPrefix(type, null)
};
