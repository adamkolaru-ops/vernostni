<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Kart Maker ‚Äì Slevy, Raz√≠tka, Body + Info od klienta</title>
  <!-- P≈ôid√°v√°me knihovnu QRCode.js z CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Firebase CDN skripty (v kompatibilitn√≠m re≈æimu) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <!-- html2canvas for rendering logo slot to PNG -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* RESET */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #f3f3f3;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    /* TABULKA NAHO≈òE */
    .info-table {
      width: 330px;
      background: #fff;
      border-radius: 2px;
      box-shadow: 0 2px 2px rgba(0,0,0,0.2);
      padding: 10px;
      margin-bottom: 10px;
    }
    .info-table table {
      border-collapse: collapse;
      width: 100%;
    }
    .info-table th, .info-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }
    .info-table thead th {
      background: #f0f0f0;
      font-weight: 600;
    }
    /* NADPIS KARTY */
    #cardTitleDisplay {
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
    }
    /* TELEFON + FAKE CARD */
    .phone-container {
      position: relative;
      margin-bottom: 20px;
    }
    .phone-image {
      width: 300px;
      display: block;
    }
    .fake-card {
      position: absolute;
      top: 76px;
      left: 22px;
      width: 257px;
      height: 363px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 0 2px rgba(0,0,0,0.3);
      pointer-events: none;
      overflow: hidden;
    }
    /* LOGO-SLOT */
    .logo-slot {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 120px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      overflow: hidden;
      padding-left: 2px;
    }
    .logo-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      object-position: left center;
    }
    .logo-text {
      white-space: pre-wrap;
      font-weight: bold;
      margin: 0;
      padding: 0;
      overflow: hidden;
      text-align: left;
    }
    /* STRIP => #stripResultImg */
    #stripResultImg {
      position: absolute;
      top: 57px;
      left: 0;
      width: 100%;
      height: auto;
      object-fit: cover;
      display: none;
      z-index: 0;
    }
    /* men≈°√≠ QR k√≥d */
    .qr-code {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 96px;
      z-index: 1;
    }
    /* U≈†ET≈òIL (vpravo) */
    .saved-amount {
      position: absolute;
      top: 157px;
      right: 10px;
      text-align: right;
      display: none;
      font-family: sans-serif;
      color: var(--discountColor, #000);
    }
    .saved-amount .saved-label {
      font-size: 12px;
      font-weight: 600;
    }
    .saved-amount .saved-value {
      display: block;
      margin-top: 2px;
      font-size: 18px;
      font-weight: 700;
    }
    /* DISCOUNT LEVEL */
    .discount-level {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 95px;
      text-align: right;
      display: none;
      color: var(--discountColor, #000);
    }
    .discount-level-rows {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      font-weight: 600;
    }
    .discount-level-values {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 2px;
      font-weight: 600;
    }
    /* RAZ√çTKA (vpravo dole) */
    .stamp-counter {
      position: absolute;
      top: 157px;
      right: 10px;
      text-align: right;
      display: none;
      font-family: sans-serif;
      color: var(--discountColor, #000);
    }
    .stamp-counter .saved-label {
      font-size: 12px;
      font-weight: 600;
    }
    .stamp-counter .saved-value {
      display: block;
      margin-top: 2px;
      font-size: 18px;
      font-weight: 700;
    }
    /* BODY (vpravo naho≈ôe) */
    .body-level {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 95px;
      text-align: right;
      display: none; 
      color: var(--discountColor, #000);
    }
    .body-level-rows {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      font-weight: 600;
    }
    .body-level-values {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 2px;
      font-weight: 600;
    }
    /* BODY dole (vpravo) */
    .body-bottom {
      position: absolute;
      top: 157px;
      right: 10px;
      text-align: right;
      display: none;
      font-family: sans-serif;
      color: var(--discountColor, #000);
    }
    .body-bottom .top-line {
      font-size: 12px;
      font-weight: 600;
    }
    .body-bottom .bottom-line {
      display: block;
      margin-top: 2px;
      font-size: 18px;
      font-weight: 700;
    }
    /* Z√ÅKAZN√çK (vlevo) */
    .customer-info {
      position: absolute;
      top: 157px;
      left: 10px;
      text-align: left;
      display: none;
      font-family: sans-serif;
      color: var(--discountColor, #000);
    }
    .customer-info .cust-label {
      font-size: 12px;
      font-weight: 600;
    }
    .customer-info .cust-value {
      display: block;
      margin-top: 2px;
      font-size: 18px;
      font-weight: 700;
    }
    /* TEXT NA STRIPU */
    .strip-text {
      position: absolute;
      display: none;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
    }
    /* FORM PANEL */
    .form-panel {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 20px;
      margin-bottom: 20px;
      width: 320px;
    }
    .form-panel label {
      font-weight: 500;
      display: block;
      margin-top: 10px;
    }
    .form-panel input[type="text"],
    .form-panel input[type="file"],
    .form-panel textarea,
    .form-panel select,
    .form-panel input[type="number"],
    .form-panel input[type="password"],
    .form-panel input[type="color"] {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 5px;
    }
    .form-panel input[type="color"] {
      width: 60px;
      height: 40px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
    }
    /* KARTY DOLE */
    .choose-style-title {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }
    .cards-container {
      display: flex;
      flex-wrap: nowrap;
      gap: 0;
    }
    .card {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 1px;
      width: 100px;
      padding: 2px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
      text-align: center;
    }
    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .card.selected {
      border-color: #2196f3;
      box-shadow: 0 3px 7px rgba(33,150,243,0.3);
    }
    .card h2 {
      margin: 0 0 5px;
      font-size: 10px;
    }
    .card img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
    }
    .card ul {
      margin: 8px 0 0;
      padding-left: 10px;
      line-height: 1.3;
      font-size: 14px;
      text-align: left;
    }
    .hidden { display: none; }
    .visible { display: block; }
    /* STRIP gener√°tor */
    .predef-strips {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .predef-strips img {
      width: 60px;
      height: auto;
      border: 2px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .predef-strips img.selected { border-color: #2196f3; }
    /* Linky a tlaƒç√≠tko dole (ke sta≈æen√≠) */
    #stripUrl {
      margin-top: 5px;
      font-size: 12px;
      word-wrap: break-word;
      max-width: 300px;
      background: #fafafa;
      padding: 6px;
      margin-bottom: 6px;
    }
    #stripView, #stripDownload {
      display: none;
      margin-bottom: 6px;
    }
    #stripCanvas {
      display: none;
    }
    /* TABULKA SLEV */
    .discount-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .discount-table th, .discount-table td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 13px;
      text-align: center;
    }
    .discount-table thead th {
      background: #fafafa;
      font-weight: bold;
    }
    .discount-table tbody tr.selectedRow {
      background: #ffeaaa;
    }
    /* SC√âN√Å≈òE KONTEJNER */
    .scenario-container {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin-top: 20px;
      display: none;
    }
    /* RAZ√çTKA: drobn√° stylizace */
    .stamp-gallery img,
    .border-gallery img {
      border: 1px solid transparent; 
      width: 64px; 
      height: auto; 
      cursor: pointer; 
      margin-right:5px;
    }
    /* TLAƒå√çTKO VYTVO≈òIT KARTU ‚Äì p≈Øvodn√≠ tlaƒç√≠tko je skryto */
    #createCardBtn {
      display: none;
    }
    #createCardBtn:hover {
      background-color: #1976d2;
    }
    /* NOV√â tlaƒç√≠tko Poslat do Firebase */
    #sendToFirebaseBtn {
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #sendToFirebaseBtn:hover {
      background-color: #45a049;
    }
    /* Styly pro pole s heslem */
    .password-container {
      position: relative;
      width: 100%;
    }
    .password-container input[type="password"],
    .password-container input[type="text"] {
      width: 100%;
      padding-right: 40px; /* M√≠sto pro ikonu oka */
    }
    .toggle-password {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      cursor: pointer;
      user-select: none; /* Zamez√≠ oznaƒçen√≠ textu ikony */
    }
  </style>
</head>
<body>

  <!-- (1) TABULKA NAHO≈òE -->
  <div class="info-table">
    <table>
      <thead>
        <tr>
          <th>Identifik√°tor</th>
          <th>Datum vytvo≈ôen√≠ karty</th>
          <th>N√°zev karty</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="tableCardID">---</td>
          <td>17.09.2025</td>
          <td id="tableCardName">Moje prvn√≠ karta</td>
          <td>Aktivn√≠</td>
        </tr>
        <tr>
          <td colspan="4" style="font-weight:600; cursor:pointer; background:#eef;">
            P≈ôidat kartu +
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- (2) NADPIS KARTY -->
  <h2 id="cardTitleDisplay">Moje prvn√≠ karta</h2>

  <!-- (3) TELEFON + FAKE CARD -->
  <div class="phone-container">
    <img 
      src="https://static.wixstatic.com/media/1cf87e_7d2b3744c04f4bf6af84a1b9868ea0b2~mv2.png"
      alt="Telefon"
      class="phone-image"
    >
    <div class="fake-card" id="fakeCard">
      <!-- STRIP => #stripResultImg -->
      <img id="stripResultImg" alt="Strip n√°hled">
      <!-- DISCOUNT LEVEL -->
      <div class="discount-level" id="discountLevelDisplay">
        <div class="discount-level-rows">
          <div id="discountLabel1">STATUS</div>
          <div id="discountLabel2">SLEVA</div>
        </div>
        <div class="discount-level-values">
          <div id="statusVal">VIP</div>
          <div id="discountVal">10%</div>
        </div>
      </div>
      <!-- U≈†ET≈òIL (vpravo) -->
      <div class="saved-amount" id="savedAmountDisplay">
        <span class="saved-label">U≈°et≈ôil</span>
        <span class="saved-value" id="savedVal">378 Kƒç</span>
      </div>
      <!-- RAZ√çTKA (vpravo dole) -->
      <div class="stamp-counter" id="stampCounterDisplay">
        <span class="saved-label" id="stampLabel">Raz√≠tka</span>
        <span class="saved-value" id="stampVal">0 / 0</span>
      </div>
      <!-- BODY (vpravo naho≈ôe) -->
      <div class="body-level" id="bodyLevelDisplay">
        <div class="body-level-rows">
          <div id="bodyLabel1">BODY</div>
        </div>
        <div class="body-level-values">
          <div id="bodyVal">0</div>
        </div>
      </div>
      <!-- BODY dole (vpravo) -->
      <div class="body-bottom" id="bodyBottomDisplay">
        <span class="top-line" id="bodyBottomTop">ZA 100B K√ÅVA ZDARMA</span>
        <span class="bottom-line" id="bodyBottomBot">10Kƒç=1BOD</span>
      </div>
      <!-- Men≈°√≠ QR k√≥d -->
      <img 
        src="https://static.wixstatic.com/media/1cf87e_9b1be513b4124062be87f14644f4c7db~mv2.png"
        alt="QR k√≥d"
        class="qr-code"
      >
      <!-- Z√°kazn√≠k (vlevo) -->
      <div class="customer-info" id="customerInfo">
        <span class="cust-label">Z√°kazn√≠k:</span>
        <span class="cust-value" id="custName">Jan Nov√°k</span>
      </div>
      <!-- Logo / N√°pis -->
      <div class="logo-slot" id="logoSlot"></div>
      <!-- Text na stripu -->
      <div class="strip-text" id="stripTextElem"></div>
    </div>
  </div>

  <!-- NOV√Å SEKCE: Detail podniku a ID kav√°rny -->
  <div class="form-panel" id="businessDetailsPanel">
    <h3>N√°zev va≈°eho podniku</h3>
    <input type="text" id="businessNameInput" placeholder="Zadejte n√°zev podniku" />
    <button id="saveBusinessBtn" onclick="saveBusinessName()">Nastavit n√°zev podniku</button>
    <div id="businessInfoDisplay">ID kav√°rny: </div>
  </div>

  <!-- NOV√Å SEKCE: Vytvo≈ôen√≠ ID karty -->
  <div class="form-panel" id="cardIDPanel">
    <h3>Vytvo≈ôen√≠ ID karty</h3>
    <button id="createCardIDBtn" onclick="createCardID()">Vytvo≈ôit ID karty</button>
    <p id="cardIDDisplay">Unik√°tn√≠ ID karty: </p>
    <p id="customerUrlDisplay">Va≈°e URL pro va≈°e z√°kazn√≠ky ke sta≈æen√≠ karty: </p>
    <!-- QR k√≥d sekce ‚Äì skryt√© dokud se karta nevytvo≈ô√≠ -->
    <div id="qrCodeSection">
      <div id="qrCodeContainer"></div>
      <br>
      <button onclick="downloadQRCode()">St√°hnout QR k√≥d</button>
      <br>
      <label>Barva QR k√≥du:</label>
      <input type="color" id="qrColor" value="#000000" onchange="updateQRCode()">
      <label>Barva pozad√≠:</label>
      <input type="color" id="qrBgColor" value="#ffffff" onchange="updateQRCode()">
      <br>
      <label>Nahr√°t logo pro QR k√≥d (PNG):</label>
      <input type="file" id="qrLogoFile" accept="image/png" onchange="updateQRCode()">
      <br>
      <label>Nahr√°t vlastn√≠ QR k√≥d (PNG):</label>
      <input type="file" id="customQRCodeFile" accept="image/png" onchange="updateQRCode()">
      <p>
        Link v p≈ô√≠padƒõ, pokud by v√°m ne≈°el naƒç√≠st qrkod:
        <a id="scanLink" href="#" target="_blank"></a>
      </p>
      <p style="text-align:center; font-size:12px; margin-top:10px;">
        Speci√°ln√≠ Designov√© k√≥dy m≈Ø≈æete vytvo≈ôit zdarma zde: <a href="https://www.qrcode-monkey.com" target="_blank">qrcode-monkey.com</a>
      </p>
    </div>
  </div>

  <!-- NOV√Å SEKCE: Adresa poboƒçky pro geonotifikace -->
  <div class="form-panel" id="branchLocationPanel" style="display:none;">
    <h3>Adresa poboƒçky (geonotifikace)</h3>
    <p id="branchLocationPrompt" style="cursor:pointer; color:#1976d2; text-decoration:underline; margin-top:6px;">
      Zadejte adresu podniku
    </p>
    <div id="branchLocationForm" style="display:none; margin-top:8px;">
      <label for="branchAddressInput">Adresa podniku:</label>
      <input type="text" id="branchAddressInput" placeholder="Nap≈ô. V√°clavsk√© n√°mƒõst√≠ 1, Praha" autocomplete="street-address">
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="branchGeocodeBtn" type="button">Vyhledat adresu</button>
        <button id="branchUseLocationBtn" type="button">Pou≈æ√≠t moji polohu</button>
      </div>
      <p id="branchAddressResult" style="font-size:12px; color:#555; margin-top:6px;"></p>
      <p id="branchCoordsDisplay" style="font-size:12px; color:#555; margin-top:2px;"></p>
      <!-- Skryt√° pole pro odesl√°n√≠ do Firebase -->
      <input type="hidden" id="branchAddressNormalized">
      <input type="hidden" id="branchLat">
      <input type="hidden" id="branchLng">
      <input type="hidden" id="branchPlaceId">
      <input type="hidden" id="branchOsmType">
      <input type="hidden" id="branchOsmId">
    </div>
  </div>

  <!-- (4) FORMUL√Å≈ò -->
  <div class="form-panel">
    <!-- Sekce: Zobrazovat jm√©no a text na stripu -->
    <input type="checkbox" id="showNameChk" checked onclick="toggleShowName()">
    <label for="showNameChk">Zobrazovat jm√©no z√°kazn√≠ka</label>
    <br><br>
    <input type="checkbox" id="showStripTextChk" onclick="toggleStripText()">
    <label for="showStripTextChk">Zobrazovat text dole na stripu</label>
    <label>Text:</label>
    <input type="text" id="stripTextVal" value="Des√°t√° k√°va je na n√°s." oninput="updateStripText()">
    <label>Barva:</label>
    <input type="color" id="stripTextColor" value="#000000" oninput="updateStripText()">
    <label>Velikost(px):</label>
    <input type="number" id="stripTextSize" value="25" style="width:60px;" oninput="updateStripText()">
    <input type="checkbox" id="stripTextBold" onclick="updateStripText()">
    <label for="stripTextBold">Tuƒçn√©</label>
    <label style="margin-top:10px;">Posun X:</label>
    <input type="number" id="stripTextPosX" value="0" style="width:60px;" oninput="updateStripText()">
    <label>Posun Y:</label>
    <input type="number" id="stripTextPosY" value="0" style="width:60px;" oninput="updateStripText()">
    <hr>
    <label for="nazevKarty">N√°zev karty:</label>
    <input type="text" id="nazevKarty" value="Moje prvn√≠ karta" oninput="updateCardTitle()">

    <hr style="margin: 20px 0;">

    <label for="staffPassword">Heslo pro obsluhu:</label>
    <p style="font-size:12px; color:#666; margin-bottom:5px;">Heslo, kter√© obsluha pot≈ôebuje pro p≈ôid√°n√≠ nap≈ô. raz√≠tka klientovi nebo bonusov√Ωch bod≈Ø. Doporuƒçen√≠: Zvolte jednoduch√© heslo, kter√© jednou za ƒças vymƒõn√≠te.</p>
    <div class="password-container">
        <input type="password" class="form-panel" id="staffPassword" name="staffPassword" placeholder="Minim√°lnƒõ 8 znak≈Ø" minlength="8">
        <span class="toggle-password" onclick="toggleStaffPasswordVisibility('staffPassword', this)">üëÅÔ∏è</span>
    </div>

    <label for="staffPasswordConfirm" style="margin-top:10px;">Ovƒõ≈ôen√≠ hesla:</label>
    <div class="password-container">
        <input type="password" class="form-panel" id="staffPasswordConfirm" name="staffPasswordConfirm" placeholder="Zadejte heslo znovu" minlength="8">
        <span class="toggle-password" onclick="toggleStaffPasswordVisibility('staffPasswordConfirm', this)">üëÅÔ∏è</span>
    </div>
    <div id="passwordError" style="color: red; font-size: 12px; margin-top: 5px; height: 15px;"></div>

    <hr style="margin: 20px 0;">
    <label for="textColor">Barva p√≠sma (pro slevov√© texty atd.):</label>
    <input type="color" id="textColor" value="#000000" oninput="updateDiscountColor()">
    <label for="cardColor">Barva karty:</label>
    <input type="color" id="cardColor" value="#ffffff" onchange="changeCardColor()">
    <p style="margin:10px 0 5px; font-weight:600;">Prav√Ω horn√≠ roh:</p>
    <input type="radio" name="horniRoh" id="radioNapis" value="napis" checked onclick="updateHorniRoh()">
    <label for="radioNapis">N√°pis</label>
    <br>
    <input type="radio" name="horniRoh" id="radioLogo" value="logo" onclick="updateHorniRoh()">
    <label for="radioLogo">Logo</label>
    <!-- N√°pis box -->
    <div id="napiBox" class="visible">
      <label for="napisText" style="margin-top:10px;">Va≈°e Logo/N√°pis:</label>
      <textarea id="napisText" rows="2" oninput="renderLogoSlot()">Va≈°e Logo/N√°pis</textarea>
      <label for="napisFont">Styl p√≠sma (Wix fonty):</label>
      <select id="napisFont" onchange="renderLogoSlot()">
        <option value="Arial">Arial</option>
        <option value="Georgia">Georgia</option>
        <option value="Helvetica">Helvetica</option>
        <option value="Tahoma">Tahoma</option>
        <option value="Trebuchet MS">Trebuchet MS</option>
        <option value="Verdana">Verdana</option>
        <option value="Wix Freed Script">Wix Freed Script</option>
        <option value="Wix Crisp Sans">Wix Crisp Sans</option>
        <option value="Wix Deco Modern">Wix Deco Modern</option>
        <option value="Wix Cafe Handwriting">Wix Cafe Handwriting</option>
        <option value="Wix Fancy Cursive">Wix Fancy Cursive</option>
      </select>
      <label for="napisAlign">Zarovn√°n√≠ textu:</label>
      <select id="napisAlign" onchange="renderLogoSlot()">
        <option value="left">Vlevo</option>
        <option value="center" selected>Na st≈ôed</option>
        <option value="right">Vpravo</option>
      </select>
      <br>
      <input type="checkbox" id="napisBold" checked onclick="renderLogoSlot()">
      <label for="napisBold">Tuƒçn√©</label>
      <label for="napisColor" style="margin-top:10px;">Barva n√°pisu:</label>
      <input type="color" id="napisColor" value="#ff0000" oninput="renderLogoSlot()">
    </div>
    <!-- Logo box -->
    <div id="logoBox" class="hidden">
      <label>Nahr√°t soubor (PNG) <small>(Ide√°ln√≠ pomƒõr nap≈ô. 4:1)</small>:</label>
      <input type="file" id="logoFile" accept="image/png" onchange="renderLogoSlot()">
    </div>
    <hr style="margin:15px 0;">
    <h4>Strip Image Generator</h4>
    <p>(Pozad√≠ + overlay ‚Üí 0‚ÄØ% = origin√°l, 100‚ÄØ% = silueta)</p>
    <div>
      <input type="radio" name="stripChoice" id="stripPredef" value="predef" onclick="updateStripChoice()">
      <label for="stripPredef">Vybrat p≈ôedp≈ôipraven√Ω vzor + barvy</label>
    </div>
    <div style="margin-bottom:10px;">
      <input type="radio" name="stripChoice" id="stripCustom" value="custom" onclick="updateStripChoice()">
      <label for="stripCustom">Nahr√°t vlastn√≠ (5:2 = 624√ó246px)</label>
    </div>
    <!-- P≈ôedp≈ôipraven√© styly -->
    <div id="predefStripBox" class="hidden">
      <label>Vzor (horn√≠ kresba):</label>
      <div class="predef-strips">
        <img src="https://static.wixstatic.com/media/1cf87e_dc47ca91c0c849bda67a6d65a9a0445b~mv2.png" alt="Vzor 1" id="predefPattern1" onclick="selectPredefPattern('pattern1')">
        <img src="https://static.wixstatic.com/media/1cf87e_dc47ca91c0c849bda67a6d65a9a0445b~mv2.png" alt="Vzor 2" id="predefPattern2" onclick="selectPredefPattern('pattern2')">
      </div>
      <label>Barva vzoru (overlay):</label>
      <input type="color" id="overlayColor" value="#ffffff" oninput="renderStrip()">
      <label>Alpha:</label>
      <input type="range" id="overlayAlpha" min="0" max="100" value="100" oninput="renderStrip()">
      <label>Barva pozad√≠ (background):</label>
      <input type="color" id="bgColor" value="#000000" oninput="renderStrip()">
      <label>Alpha:</label>
      <input type="range" id="bgAlpha" min="0" max="100" value="0" oninput="renderStrip()">
    </div>
    <!-- Vlastn√≠ strip -->
    <div id="customStripBox" class="hidden">
      <label>Nahr√°t strip (5:2 = 624√ó246px):</label>
      <input type="file" id="stripFile" accept="image/*" onchange="renderStrip()">
    </div>
    <!-- Tlaƒç√≠tko a linky -->
    <button style="margin-top:10px;" onclick="renderStrip()">Vytvo≈ôit strip</button>
    <p id="stripUrl"></p>
    <a id="stripView" href="#" target="_blank">Otev≈ô√≠t strip v nov√©m oknƒõ</a>
    <br>
    <button id="stripDownload" onclick="downloadStrip()">St√°hnout strip</button>
  </div>

  <!-- (5) KARTY DOLE + TLAƒå√çTKO -->
  <div class="choose-style-title">Vyberte styl karty</div>
  <div class="cards-container">
    <div class="card" id="card-procentni" onclick="selectCard('card-procentni')">
      <h2>Procentn√≠ sleva</h2>
      <img src="https://static.wixstatic.com/media/1cf87e_1b6bd7c6f0714a54b2377e6888de446e~mv2.png" alt="Procentn√≠ sleva">
      <ul>
        <li>Jednoduchost pro klienty</li>
        <li>Velk√° variabilita slev</li>
        <li>Dlouhodob√° motivace</li>
      </ul>
    </div>
    <div class="card" id="card-razitka" onclick="selectCard('card-razitka')">
      <h2>Raz√≠tka</h2>
      <img src="https://static.wixstatic.com/media/1cf87e_f661c5e0c0e44014a6f7229d4178dee9~mv2.png" alt="Raz√≠tka">
      <ul>
        <li>V√Ωhody raz√≠tkov√©ho syst√©mu</li>
        <li>Snadn√© naƒç√≠t√°n√≠ a spr√°va</li>
      </ul>
    </div>
    <div class="card" id="card-body" onclick="selectCard('card-body')">
      <h2>Body</h2>
      <img src="https://static.wixstatic.com/media/1cf87e_ca5f3dda10ba401795176a01ef46564f~mv2.png" alt="Body">
      <ul>
        <li>Vyzkou≈°ejte bodov√Ω syst√©m</li>
        <li>1 bod za ka≈æd√Ωch 10 Kƒç</li>
      </ul>
    </div>
  </div>
  <div style="margin-top:20px; text-align:center;">
    <button onclick="confirmCardSelection()">Potvrdit v√Ωbƒõr karty</button>
    <p style="font-size:12px; margin-top:5px;">(Je mo≈æn√© kdykoli zmƒõnit)</p>
  </div>

  <!-- (6a) SC√âN√Å≈òE - SLEVOV√Å KARTA -->
  <div class="scenario-container" id="discountScenario">
    <h3>Slevov√° karta ‚Äì zadejte √∫rovnƒõ</h3>
    <table class="discount-table" id="discountTable">
      <thead>
        <tr>
          <th>√örove≈à</th>
          <th>N√°zev</th>
          <th>Sleva (%)</th>
          <th>Celkov√Ω z≈Østatek</th>
        </tr>
      </thead>
      <tbody>
        <tr onclick="selectDiscountRow(this)">
          <td>1</td>
          <td><input type="text" id="status1" value="VIP" style="width:90px;" oninput="updateDiscountFromTable()"></td>
          <td><input type="number" id="sleva1" value="10" style="width:60px;" oninput="updateDiscountFromTable()"></td>
          <td><span style="white-space:nowrap;">0 a≈æ </span><input type="number" id="zustatek1" value="9999" style="width:80px;"></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4">
        <button onclick="addDiscountRow()">+ P≈ôidat √∫rove≈à</button>
        <button onclick="removeDiscountRow()">‚àí Odebrat</button>
      </td>
    </tr>
  </tfoot>
</table>
</div>

<!-- (6b) SC√âN√Å≈òE - RAZ√çTKOV√Å KARTA -->
<div class="scenario-container" id="razitkaScenario">
  <h3>Raz√≠tkov√° karta</h3>
  <div class="razitka-form">
    <label>Vyberte celkov√Ω poƒçet raz√≠tek:</label>
    <input type="number" id="stampCount" value="10" style="width:80px;" oninput="onStampCountChange()">
    <!-- NOV√â pole dle zad√°n√≠ pro v√Ωchoz√≠ poƒçet raz√≠tek -->
    <label>Kolik raz√≠tek bude m√≠t u≈æivatel po p≈ôid√°n√≠ karty (v√Ωchoz√≠ 0):</label>
    <input type="number" id="stampValInput" value="10" style="width:60px;">
    <label>Vyplnƒõno (0 a≈æ N):</label>
    <input type="range" id="stampFilled" min="0" max="10" value="10" style="width:120px;" oninput="renderStrip()">
    <label>Posun X (px) pro raz√≠tka:</label>
    <input type="number" id="stampOffsetX" value="0" style="width:80px;" oninput="renderStrip()">
    <label>Posun Y (px) pro raz√≠tka:</label>
    <input type="number" id="stampOffsetY" value="0" style="width:80px;" oninput="renderStrip()">
    <label>Velikost vnit≈ôku (raz√≠tko) (px):</label>
    <input type="number" id="stampSize" value="100" style="width:80px;" oninput="renderStrip()">
    <label>Mezera mezi raz√≠tky (px):</label>
    <input type="number" id="stampGap" value="10" style="width:80px;" oninput="renderStrip()">
    <hr>
    <h4>Design vnit≈ôku (raz√≠tko) + overlay alpha</h4>
    <div>
      <input type="radio" name="stampChoice" id="stampPredef" value="stampPredef" onclick="renderStrip()" checked>
      <label for="stampPredef">Vybrat p≈ôedp≈ôipraven√© raz√≠tko</label>
    </div>
    <div>
      <input type="radio" name="stampChoice" id="stampCustom" value="stampCustom" onclick="renderStrip()">
      <label for="stampCustom">Nahr√°t vlastn√≠ PNG</label>
    </div>
    <div class="stamp-gallery" style="margin-top:6px;">
      <img src="https://static.wixstatic.com/media/1cf87e_f7284a8ad6d1438c9e79eb3d0818890a~mv2.png" alt="Raz√≠tko 0" id="stamp0" onclick="selectPredefStamp('stamp0')">
      <img src="https://static.wixstatic.com/media/1cf87e_b902bf7ff01d45679dc1964eedc548d2~mv2.png" alt="Raz√≠tko 1" id="stamp1" onclick="selectPredefStamp('stamp1')">
      <img src="https://static.wixstatic.com/media/1cf87e_4f9563aebb5d4391ab392f456c1f8c74~mv2.png" alt="Raz√≠tko 2" id="stamp2" onclick="selectPredefStamp('stamp2')">
    </div>
    <label>Barva raz√≠tka (overlay):</label>
    <input type="color" id="stampColor" value="#ffffff" oninput="renderStrip()">
    <label>Alpha (0‚Äì100):</label>
    <input type="range" id="stampAlpha" min="0" max="100" value="0" oninput="renderStrip()">
    <div style="margin-top:6px;">
      <label>Vlastn√≠ raz√≠tko (PNG):</label>
      <input type="file" id="stampFile" accept="image/png" onchange="renderStrip()">
      <label>Barva (overlay):</label>
      <input type="color" id="stampColor2" value="#ffffff" oninput="renderStrip()">
      <label>Alpha:</label>
      <input type="range" id="stampAlpha2" min="0" max="100" value="0" oninput="renderStrip()">
    </div>
    <label style="margin-top:10px;">Zapnout ‚Äústroke‚Äù i pro raz√≠tko?</label>
    <input type="checkbox" id="stampStrokeOn" onclick="renderStrip()">
    <label>Barva:</label>
    <input type="color" id="stampStrokeColor" value="#000000" oninput="renderStrip()">
    <label>Size(px):</label>
    <input type="number" id="stampStrokeSize" value="2" style="width:60px;" oninput="renderStrip()">
    <label>Alpha(0‚Äì100):</label>
    <input type="range" id="stampStrokeAlpha" min="0" max="100" value="100" oninput="renderStrip()">
    <hr>
    <h4>Ohraniƒçen√≠ (border) + overlay alpha</h4>
    <label>Velikost ohraniƒçen√≠ (px):</label>
    <input type="number" id="borderSize" value="80" style="width:80px;" oninput="renderStrip()">
    <div style="margin:6px 0;">
      <label>Zobrazovat ohraniƒçen√≠?</label>
      <input type="checkbox" id="borderEnabled" onclick="renderStrip()">
    </div>
    <div>
      <input type="radio" name="borderChoice" id="borderPredef" value="borderPredef" onclick="renderStrip()">
      <label for="borderPredef">Vybrat p≈ôedp≈ôipraven√©</label>
    </div>
    <div>
      <input type="radio" name="borderChoice" id="borderCustom" value="borderCustom" onclick="renderStrip()">
      <label for="borderCustom">Nahr√°t vlastn√≠ PNG</label>
    </div>
    <div class="border-gallery" style="margin-top:6px;">
      <img src="https://static.wixstatic.com/media/1cf87e_38adc779dcf74126b32459b591f7405d~mv2.png" alt="Border0" id="border0" onclick="selectPredefBorder('border0')">
      <img src="https://static.wixstatic.com/media/1cf87e_f9c1f6035fd14a6c87eb72e797edb4e1~mv2.png" alt="Border1" id="border1" onclick="selectPredefBorder('border1')">
      <img src="https://static.wixstatic.com/media/1cf87e_c9af8c73f3dc4513bcae356276cc9809~mv2.png" alt="Border2" id="border2" onclick="selectPredefBorder('border2')">
    </div>
    <label>Barva ohraniƒçen√≠ (overlay):</label>
    <input type="color" id="borderColor" value="#ffffff" oninput="renderStrip()">
    <label>Alpha:</label>
    <input type="range" id="borderAlpha" min="0" max="100" value="0" oninput="renderStrip()">
    <div style="margin-top:6px;">
      <label>Vlastn√≠ ohraniƒçen√≠ (PNG):</label>
      <input type="file" id="borderFile" accept="image/png" onchange="renderStrip()">
      <label>Barva (overlay):</label>
      <input type="color" id="borderColor2" value="#ffffff" oninput="renderStrip()">
      <label>Alpha:</label>
      <input type="range" id="borderAlpha2" min="0" max="100" value="0" oninput="renderStrip()">
    </div>
    <label style="margin-top:10px;">Zapnout ‚Äústroke‚Äù okolo ohraniƒçen√≠?</label>
    <input type="checkbox" id="borderStrokeOn" onclick="renderStrip()">
    <label>Barva:</label>
    <input type="color" id="borderStrokeColor" value="#000000" oninput="renderStrip()">
    <label>Size(px):</label>
    <input type="number" id="borderStrokeSize" value="2" style="width:60px;" oninput="renderStrip()">
    <label>Alpha(0‚Äì100):</label>
    <input type="range" id="borderStrokeAlpha" min="0" max="100" value="100" oninput="renderStrip()">
    <hr style="margin:15px 0;">
    <h4>Pr≈Øbƒõ≈æn√° sleva (text/obr√°zek):</h4>
    <label>Chcete pr≈Øbƒõ≈ænou slevu?</label>
    <div>
      <input type="radio" name="prubeznaSleva2" id="pbYes" onclick="togglePrubezna2(true)"> Ano
      <input type="radio" name="prubeznaSleva2" id="pbNo" checked onclick="togglePrubezna2(false)"> Ne
    </div>
    <div id="pbSlevaBox" style="display:none; border:1px solid #ccc; padding:6px; margin-top:8px;">
      <label>Na kolik√°t√©m raz√≠tku chcete pr≈Øbƒõ≈ænou slevu?</label>
      <input type="number" id="pbIndex" value="5" style="width:80px;" oninput="renderStrip()">
      <label>Volba: text / obr√°zek?</label>
      <div>
        <input type="radio" name="pbType" id="pbTypeText" onclick="renderStrip()" checked> Text
        <input type="radio" name="pbType" id="pbTypeImg" onclick="renderStrip()"> Obr√°zek
      </div>
      <!-- TEXT BOX -->
      <div id="pbTextBox" style="margin-left:10px; margin-top:6px;">
        <label>Pr≈Øb. text:</label>
        <input type="text" id="pbTextVal" value="50%" style="width:80px;" oninput="renderStrip()">
        <label>Velikost (px):</label>
        <input type="number" id="pbTextSize" value="20" style="width:50px;" oninput="renderStrip()">
        <label>Barva:</label>
        <input type="color" id="pbTextColor" value="#000000" oninput="renderStrip()">
        <label>X:</label>
        <input type="number" id="pbTextOffsetX" value="0" style="width:40px;" oninput="renderStrip()">
        <label>Y:</label>
        <input type="number" id="pbTextOffsetY" value="0" style="width:40px;" oninput="renderStrip()">
      </div>
      <!-- OBR√ÅZEK BOX -->
      <div id="pbImgBox" style="margin-left:10px; margin-top:6px; display:none;">
        <label>Nahr√°t PNG:</label>
        <input type="file" id="pbFile" accept="image/png" onchange="renderStrip()">
        <label>Velikost (px):</label>
        <input type="number" id="pbImgSize" value="40" style="width:50px;" oninput="renderStrip()">
        <label>X:</label>
        <input type="number" id="pbImgOffsetX" value="0" style="width:40px;" oninput="renderStrip()">
        <label>Y:</label>
        <input type="number" id="pbImgOffsetY" value="0" style="width:40px;" oninput="renderStrip()">
      </div>
    </div>
  </div>
</div> <!-- close razitkaScenario -->

  <!-- (6c) BODOV√Å KARTA -->
  <div class="scenario-container" id="bodyScenario">
    <h3>Bodov√° karta</h3>
    <label>Text vpravo naho≈ôe (nap≈ô. BODY):</label>
    <input type="text" id="bodyLabel1Input" value="BODY" style="width:80px;" oninput="updateBodyDisplay()">
    <label>Poƒçet bod≈Ø:</label>
    <input type="number" id="bodyValInput" value="97" style="width:60px;" oninput="updateBodyDisplay()">

    <hr>
    <label>Text vpravo dole (≈ô.1):</label>
    <input type="text" id="bodyBottomTopInput" value="ZA 100B K√ÅVA ZDARMA" oninput="updateBodyDisplay()">
    <label>Text vpravo dole (≈ô.2):</label>
    <input type="text" id="bodyBottomBotInput" value="10Kƒç=1BOD" oninput="updateBodyDisplay()">

    <hr>
    <label>Nastavit kolik Kƒç = kolik bod≈Ø (libovoln√Ω text):</label>
    <input type="text" id="bodyKonverze" value="10Kƒç=1BOD" oninput="updateBodyDisplay()">
  </div>

  <!-- (7) INFORMACE OD KLIENTA -->
  <div class="scenario-container" id="clientInfoScenario">
    <h3>Informace od klienta:</h3>
    <p>Vyberte a nastavte povinnost vybran√Ωch √∫daj≈Ø:</p>
    <ul style="list-style-type: disc; margin-left:20px;">
      <li>
        <label>Jm√©no</label>
      </li>
      <li>
        <label>P≈ô√≠jmen√≠</label>
      </li>
      <li>
        <label>Email</label>
      </li>
      <li>
        <input type="checkbox" id="clientDob" checked>
        <label for="clientDob">Datum narozen√≠</label>
        <input type="checkbox" id="clientDobRequired">
        <label for="clientDobRequired">Povinn√©</label>
      </li>
      <li>
        <input type="checkbox" id="clientPhone" checked>
        <label for="clientPhone">Telefon</label>
        <input type="checkbox" id="clientPhoneRequired">
        <label for="clientPhoneRequired">Povinn√©</label>
      </li>
    </ul>
    <p style="font-size:12px; color:#666;">(V≈°e bude souƒç√°st√≠ formul√°≈ôe pro klienta.)</p>
  </div>

  <div style="text-align:center; margin-top:20px;">
    <button id="collectData">Seber data</button>
  </div>

  <pre id="result" style="white-space: pre-wrap; background:#fff; padding:10px; border:1px solid #ccc; width:320px; margin:10px auto;"></pre>

  <div id="send-wrapper" style="text-align:center; margin-top:20px; display:none;">
    <button id="sendToFirebaseFromCollect">Odeslat do Firebase</button>
  </div>
  <p id="resultFirebase" style="margin-top:20px; font-weight:bold;"></p>
  <div style="text-align:center; margin-top:10px;">
    <input type="file" id="uploadImageInput" />
    <button id="uploadImagesBtn">Poslat obr√°zky</button>
  </div>
  <p id="uploadStatus" style="margin-top:10px; font-weight:bold;"></p>

  <!-- Canvas pro generov√°n√≠ stripu -->
  <canvas id="stripCanvas" width="624" height="246" style="display:none;"></canvas>

  <script>
    document.getElementById('collectData').addEventListener('click', () => {
      const vybrana = document.querySelector('.card.selected');
      let output = 'cardType: ' + (vybrana ? vybrana.id : '') + '\n';

      // Sb√≠rat data z obecn√Ωch pol√≠
      document.querySelectorAll('input:not([type="file"]), textarea, select').forEach(f => {
        // P≈ôeskoƒç√≠me inputy z tabulky slev, proto≈æe je sebereme zvl√°≈°≈•
        if (f.closest('#discountTable')) return;
        const key = f.id || f.name;
        if (!key || key === 'cardType' || f.type === 'file') return;
        let val = '';
        if (f.type === 'checkbox' || f.type === 'radio') {
          if (f.checked) val = f.value || 'on';
        } else {
          val = f.value;
        }
        output += key + ': ' + val + '\n';
      });

      // Sb√≠rat data ze slevov√© tabulky a v≈ædy vygenerovat 3 √∫rovnƒõ dle pravidel
      const discountRows = document.querySelectorAll('#discountTable tbody tr');
      let statuses = [], slevy = [], zustatky = [];
      discountRows.forEach((row, idx) => {
        const statusInput = row.querySelector('input[type="text"]');
        const slevaInput = row.querySelectorAll('input[type="number"]')[0];
        // Prvn√≠ ≈ô√°dek m√° p≈ôed inputem pro z≈Østatek je≈°tƒõ span "0 a≈æ ", proto mus√≠me vz√≠t druh√Ω input[type=number] pro prvn√≠ ≈ô√°dek, jinak prvn√≠
        let zustatekInput;
        if (idx === 0) {
          zustatekInput = row.querySelectorAll('input[type="number"]')[1];
        } else {
          zustatekInput = row.querySelectorAll('input[type="number"]')[1] || row.querySelectorAll('input[type="number"]')[0];
        }
        statuses.push(statusInput ? statusInput.value : '');
        slevy.push(slevaInput ? slevaInput.value : '');
        zustatky.push(zustatekInput ? zustatekInput.value : '');
      });
      // fallback logika
      for (let i = 0; i < 3; i++) {
        if (!statuses[i]) statuses[i] = statuses[i-1] || statuses[0] || '';
        if (!slevy[i]) slevy[i] = slevy[i-1] || slevy[0] || '';
        if (!zustatky[i]) zustatky[i] = zustatky[i-1] || zustatky[0] || '';
      }
      // z√°pis do v√Ωsledku
      for (let i = 0; i < 3; i++) {
        output += `status${i+1}: ${statuses[i]}\n`;
        output += `sleva${i+1}: ${slevy[i]}\n`;
        output += `zustatek${i+1}: ${zustatky[i]}\n`;
      }

      // P≈ôidat ostatn√≠ specifick√° data
      const cardIdText = document.getElementById('cardIDDisplay').textContent.trim();
      const pureCardId = cardIdText.replace('Unik√°tn√≠ ID karty: ', '');
      output += 'cardID: ' + pureCardId + '\n';
      const bizName = document.getElementById('businessNameInput').value.trim();
      if (bizName) output += 'businessName: ' + bizName + '\n';
      const bizIdText = document.getElementById('businessInfoDisplay').textContent.trim();
      const businessID = bizIdText.replace('ID kav√°rny: ', '').trim();
      output += 'businessID: ' + businessID + '\n';
      const custFullUrl = document.getElementById('customerUrlDisplay').textContent.trim();
      if (custFullUrl) {
        const customerUrl = custFullUrl.replace('Va≈°e URL pro va≈°e z√°kazn√≠ky ke sta≈æen√≠ karty: ', '');
        output += 'customerUrl: ' + customerUrl + '\n';
      }
      output += 'patternURL: ' + ((typeof selectedPattern !== 'undefined' && selectedPattern)
        ? document.getElementById('predefPattern' + selectedPattern.slice(-1)).src
        : '') + '\n';
      output += 'stampURL: ' + ((typeof stampSelected !== 'undefined' && stampSelected)
        ? stampSelected
        : '') + '\n';
      output += 'borderURL: ' + ((typeof borderSelected !== 'undefined' && borderSelected)
        ? borderSelected
        : '') + '\n';
      document.getElementById('result').textContent = output;
      // Show the send button after data collection
      document.getElementById('send-wrapper').style.display = 'block';
    });
  </script>

  <script>
    // Receive fullId from other HTML via BroadcastChannel
    let fullId = '';
    const channel = new BroadcastChannel('id-channel');
    channel.onmessage = ev => {
      if (ev.data.fullId) {
        fullId = ev.data.fullId;
        // Ulo≈æ√≠me fullId glob√°lnƒõ pro p≈ô√≠stup z jin√Ωch funkc√≠
        window.currentFullId = fullId;
        localStorage.setItem('currentFullId', fullId);
        console.log('üì° P≈ôijato fullId z BroadcastChannel:', fullId);
        
        const wixInd = document.getElementById('wixIdIndicator');
        if (wixInd) wixInd.textContent = 'ID karty: ' + fullId;
        fetchAndPopulateFirestoreData(fullId);
      }
    };
    async function fetchAndPopulateFirestoreData(fullId) {
      const CARDDATA_URL = "https://us-central1-vernostkarty-db.cloudfunctions.net/getCardData";
      try {
        const resp = await fetch(`${CARDDATA_URL}?fullId=${fullId}`);
        const j = await resp.json();
        if (!j.success) {
          console.error('Error fetching card data:', j.error);
          return;
        }
        const data = j.data;
        Object.keys(data).forEach(key => {
          const el = document.getElementById(key);
          if (!el) return;
          if (el.tagName === 'INPUT') {
            if (el.type === 'checkbox' || el.type === 'radio') {
              el.checked = Boolean(data[key]);
            } else if (el.type === 'file') {
              // skip file inputs (cannot set value programmatically)
            } else {
              el.value = data[key];
            }
          } else if (el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
            el.value = data[key];
          } else if (el.tagName === 'IMG') {
            el.src = data[key];
            el.style.display = 'block';
          } else {
            el.textContent = data[key];
          }
        });
        // always update business and card displays
        // --- DOPLNƒöN√ç: discount levels do tabulky ---
        const discountRows = document.querySelectorAll('#discountTable tbody tr');
        if (discountRows.length > 0) {
          // level1
          if (data.level1_status) discountRows[0].querySelector('input[type="text"]').value = data.level1_status;
          if (data.level1_sleva) discountRows[0].querySelectorAll('input[type="number"]')[0].value = data.level1_sleva;
          if (data.level1_zustatek) discountRows[0].querySelectorAll('input[type="number"]')[1].value = data.level1_zustatek;
          // level2
          if (discountRows[1]) {
            if (data.level2_status) discountRows[1].querySelector('input[type="text"]').value = data.level2_status;
            if (data.level2_sleva) discountRows[1].querySelectorAll('input[type="number"]')[0].value = data.level2_sleva;
            if (data.level2_zustatek) discountRows[1].querySelectorAll('input[type="number"]')[1].value = data.level2_zustatek;
          }
          // level3
          if (discountRows[2]) {
            if (data.level3_status) discountRows[2].querySelector('input[type="text"]').value = data.level3_status;
            if (data.level3_sleva) discountRows[2].querySelectorAll('input[type="number"]')[0].value = data.level3_sleva;
            if (data.level3_zustatek) discountRows[2].querySelectorAll('input[type="number"]')[1].value = data.level3_zustatek;
          }
        }
        // --- KONEC DOPLNƒöN√ç ---
        const bizName = data.businessName || '';
        const bizId = data.businessID || '';
        document.getElementById('businessNameInput').value = bizName;
        document.getElementById('businessInfoDisplay').textContent = 'ID kav√°rny: ' + bizId;
        cardID = data.cardID || '';
        document.getElementById('cardIDDisplay').textContent = 'Unik√°tn√≠ ID karty: ' + cardID;
        const custUrl = cardID ? 'https://onlineloyaltycards.com/cafe/?id=' + fullId.slice(-12) : '';
        document.getElementById('customerUrlDisplay').textContent = 'Va≈°e URL pro va≈°e z√°kazn√≠ky ke sta≈æen√≠ karty: ' + custUrl;
        if (cardID) updateQRCode();
        document.getElementById('cardIDPanel').style.display = 'block';
        document.getElementById('businessDetailsPanel').style.display = 'block';
        // persist global business vars so ID kav√°rny stays same when name changes
        savedBusinessName = bizName;
        businessID = bizId;
        const createBtn = document.getElementById('createCardIDBtn');
        if (cardID) {
          createBtn.style.display = 'none';
          // Show branch location panel when card exists
          showBranchPanel(true);
          setupBranchLocationUI();
        } else {
          createBtn.style.display = 'inline-block';
        }
        // If branch location was previously saved, populate UI and show form
        if (data.branchAddressNormalized || (data.branchLat && data.branchLng)) {
          const addr = data.branchAddressNormalized || '';
          const lat = data.branchLat || '';
          const lng = data.branchLng || '';
          const pid = data.branchPlaceId || '';
          const ot  = data.branchOsmType || '';
          const oid = data.branchOsmId || '';
          const input = document.getElementById('branchAddressInput');
          if (input && addr) input.value = addr;
          updateBranchDisplays(addr, lat, lng, pid, ot, oid);
          const form = document.getElementById('branchLocationForm');
          if (form) form.style.display = 'block';
        }
        // load saved card type from Firestore and apply UI
        const savedCardType = data.cardType || '';
        if (savedCardType) {
          selectCard(savedCardType);
          confirmCardSelection();
        }
        // trigger input/change events to update preview UI
        document.querySelectorAll('input:not([type="file"]), textarea, select').forEach(el => {
          el.dispatchEvent(new Event('input'));
          el.dispatchEvent(new Event('change'));
        });
        // apply all update functions so fake card reflects loaded data
        toggleShowName();
        toggleStripText();
        updateHorniRoh();
        updateBodyDisplay();
        updateCardTitle();
        changeCardColor();
        updateStripText();
        updateDiscountColor();
        updateDiscountFromTable();
      } catch (e) {
        console.error('Error fetching card data:', e);
      }
    }
    // continuous data collection & preview update
    document.querySelectorAll('input:not([type="file"]), textarea, select').forEach(el => {
      el.addEventListener('input', () => {
        document.getElementById('collectData').click();
        updateCardTitle(); changeCardColor(); updateStripText(); updateDiscountColor();
        updateDiscountFromTable(); toggleShowName(); toggleStripText(); updateHorniRoh(); updateBodyDisplay();
      });
      el.addEventListener('change', () => {
        document.getElementById('collectData').click();
        updateCardTitle(); changeCardColor(); updateStripText(); updateDiscountColor();
        updateDiscountFromTable(); toggleShowName(); toggleStripText(); updateHorniRoh(); updateBodyDisplay();
      });
    });
  </script>

  <script>
    // --- P≈Øvodn√≠ funkce (discount, raz√≠tka, aktualizace obsahu karty, renderov√°n√≠ stripu atd.) ---
    let discountSelectedRow = null;
    function selectDiscountRow(tr) {
      const rows = tr.parentNode.querySelectorAll('tr');
      rows.forEach(r => r.classList.remove('selectedRow'));
      tr.classList.add('selectedRow');
      discountSelectedRow = tr;
    }
    function addDiscountRow() {
      const tbody = document.getElementById('discountTable').querySelector('tbody');
      const rows = tbody.querySelectorAll('tr');
      if (rows.length >= 3) return;
      const newIndex = rows.length + 1;
      const newRow = document.createElement('tr');
      newRow.onclick = () => selectDiscountRow(newRow);
      newRow.innerHTML = `
        <td>${newIndex}</td>
        <td><input type="text" style="width:90px;" oninput="updateDiscountFromTable()"></td>
        <td><input type="number" style="width:60px;" oninput="updateDiscountFromTable()"></td>
        <td><input type="number" style="width:80px;"></td>
      `;
      tbody.appendChild(newRow);
    }
    function removeDiscountRow() {
      const tbody = document.getElementById('discountTable').querySelector('tbody');
      const rows = tbody.querySelectorAll('tr');
      if (rows.length <= 1) return;
      if (!discountSelectedRow) {
        alert('Nejd≈ô√≠ve oznaƒçte ≈ô√°dek tabulky kliknut√≠m.');
        return;
      }
      tbody.removeChild(discountSelectedRow);
      discountSelectedRow = null;
      const reRows = tbody.querySelectorAll('tr');
      for (let i = 0; i < reRows.length; i++) {
        reRows[i].cells[0].textContent = (i + 1).toString();
      }
    }
    function updateDiscountFromTable() {
      const row1 = document.getElementById('discountTable').querySelector('tbody tr');
      if (!row1) return;
      const titleVal = row1.cells[1].querySelector('input').value || 'VIP';
      const discountVal = row1.cells[2].querySelector('input').value || '10';
      document.getElementById('statusVal').textContent = titleVal;
      document.getElementById('discountVal').textContent = discountVal + '%';
    }
    function selectCard(id) {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      document.getElementById(id).classList.add('selected');
    }
    function confirmCardSelection() {
      console.log('confirmCardSelection invoked, selected:', document.querySelector('.card.selected')?.id);
      alert('confirmCardSelection invoked, selected: ' + (document.querySelector('.card.selected')?.id || 'none'));
      document.getElementById('discountScenario').style.display = 'none';
      document.getElementById('razitkaScenario').style.display = 'none';
      document.getElementById('bodyScenario').style.display = 'none';
      document.getElementById('discountLevelDisplay').style.display = 'none';
      document.getElementById('savedAmountDisplay').style.display = 'none';
      document.getElementById('stampCounterDisplay').style.display = 'none';
      document.getElementById('bodyLevelDisplay').style.display = 'none';
      document.getElementById('bodyBottomDisplay').style.display = 'none';
      document.getElementById('clientInfoScenario').style.display = 'none';
      const sel = document.querySelector('.card.selected');
      if (!sel) {
        alert('Nejd≈ô√≠ve vyberte styl karty!');
        return;
      }
      if (sel.id === 'card-procentni') {
        document.getElementById('discountScenario').style.display = 'block';
        document.getElementById('discountLevelDisplay').style.display = 'block';
        document.getElementById('savedAmountDisplay').style.display = 'block';
        updateDiscountFromTable();
      }
      else if (sel.id === 'card-razitka') {
        document.getElementById('razitkaScenario').style.display = 'block';
        document.getElementById('stampCounterDisplay').style.display = 'block';
      }
      else if (sel.id === 'card-body') {
        console.log('card-body branch entered');
        const bs = document.getElementById('bodyScenario');
        console.log('bodyScenario element:', bs, 'current display:', bs.style.display);
        document.getElementById('bodyScenario').style.display = 'block';
        console.log('bodyScenario after show display:', bs.style.display);
        document.getElementById('bodyLevelDisplay').style.display = 'block';
        document.getElementById('bodyBottomDisplay').style.display = 'block';
        updateBodyDisplay();
      }
      document.getElementById('clientInfoScenario').style.display = 'block';
      renderStrip();
    }
    function updateBodyDisplay() {
      const label1 = document.getElementById('bodyLabel1Input') ? document.getElementById('bodyLabel1Input').value : 'BODY';
      const val1   = document.getElementById('bodyValInput').value || '0';
      document.getElementById('bodyLabel1').textContent = label1;
      document.getElementById('bodyVal').textContent    = val1;
      const top = document.getElementById('bodyBottomTopInput').value || 'ZA 100B K√ÅVA ZDARMA';
      const bot = document.getElementById('bodyBottomBotInput').value || '10Kƒç=1BOD';
      document.getElementById('bodyBottomTop').textContent = top;
      document.getElementById('bodyBottomBot').textContent = bot;
    }
    function toggleShowName() {
      const on = document.getElementById('showNameChk').checked;
      document.getElementById('customerInfo').style.display = on ? 'block' : 'none';
    }
    function toggleStripText() {
      const on = document.getElementById('showStripTextChk').checked;
      document.getElementById('stripTextElem').style.display = on ? 'block' : 'none';
    }
    function updateStripText() {
      const val  = document.getElementById('stripTextVal').value || '';
      const c    = document.getElementById('stripTextColor').value || '#000';
      const s    = +document.getElementById('stripTextSize').value || 25;
      const bold = document.getElementById('stripTextBold').checked;
      const posX = +document.getElementById('stripTextPosX').value || 0;
      const posY = +document.getElementById('stripTextPosY').value || 0;
      const elem = document.getElementById('stripTextElem');
      elem.innerHTML = '';
      elem.textContent = val;
      elem.style.color = c;
      elem.style.fontSize = s + 'px';
      elem.style.fontWeight = bold ? 'bold' : 'normal';
      elem.style.bottom = (10 - posY) + 'px';
      renderStrip();
    }
    function updateCardTitle() {
      const val = document.getElementById('nazevKarty').value || 'Moje prvn√≠ karta';
      document.getElementById('cardTitleDisplay').textContent = val;
      document.getElementById('tableCardName').textContent    = val;
    }
    function updateDiscountColor() {
      const col = document.getElementById('textColor').value;
      document.documentElement.style.setProperty('--discountColor', col);
    }
    function changeCardColor() {
      const c = document.getElementById('cardColor').value;
      document.getElementById('fakeCard').style.backgroundColor = c;
    }
    function updateHorniRoh() {
      const napiBox = document.getElementById('napiBox');
      const logoBox = document.getElementById('logoBox');
      if (document.getElementById('radioNapis').checked) {
        napiBox.classList.remove('hidden');
        logoBox.classList.add('hidden');
      } else {
        napiBox.classList.add('hidden');
        logoBox.classList.remove('hidden');
      }
      renderLogoSlot();
    }
    function renderLogoSlot() {
      const slot = document.getElementById('logoSlot');
      slot.innerHTML = '';
      const isNapis = document.getElementById('radioNapis').checked;
      const fileInput = document.getElementById('logoFile');
      if (isNapis) {
        const textVal = document.getElementById('napisText').value || '';
        const bold    = document.getElementById('napisBold').checked;
        const fontFam = document.getElementById('napisFont').value;
        const color   = document.getElementById('napisColor').value;
        const align   = document.getElementById('napisAlign').value;
        const div = document.createElement('div');
        div.className = 'logo-text';
        div.style.fontFamily = fontFam;
        div.style.fontWeight = bold ? 'bold' : 'normal';
        div.style.color      = color;
        div.style.textAlign  = align;
        div.style.lineHeight = '1.2';
        div.innerHTML        = textVal.replace(/\n/g, '<br>');
        slot.appendChild(div);
        autoSizeText(div, 120, 45);
      }
      else {
        if (fileInput.files && fileInput.files[0]) {
          const img = document.createElement('img');
          img.className = 'logo-img';
          img.src = URL.createObjectURL(fileInput.files[0]);
          slot.appendChild(img);
        }
        else {
          const textVal = document.getElementById('napisText').value || '(Logo text)';
          const bold    = document.getElementById('napisBold').checked;
          const fontFam = document.getElementById('napisFont').value;
          const color   = document.getElementById('napisColor').value;
          const align   = document.getElementById('napisAlign').value;
          const div = document.createElement('div');
          div.className = 'logo-text';
          div.style.fontFamily = fontFam;
          div.style.fontWeight = bold ? 'bold' : 'normal';
          div.style.color      = color;
          div.style.textAlign  = align;
          div.style.lineHeight = '1.2';
          div.innerHTML        = textVal.replace(/\n/g, '<br>');
          slot.appendChild(div);
          autoSizeText(div, 120, 45);
        }
      }
    }
    function autoSizeText(el, maxW, maxH) {
      const maxFont = 50;
      const minFont = 8;
      for (let size = maxFont; size >= minFont; size--) {
        el.style.fontSize   = size + 'px';
        el.style.lineHeight = (size * 1.2) + 'px';
        if (el.scrollWidth <= maxW && el.scrollHeight <= maxH) {
          break;
        }
      }
    }
    function onStampCountChange() {
      const n = +document.getElementById('stampCount').value || 10;
      const sf = document.getElementById('stampFilled');
      sf.max = n;
      if (+sf.value > n) {
        sf.value = n;
      }
      renderStrip();
    }
    function updateStripChoice() {
      const predefBox = document.getElementById('predefStripBox');
      const customBox = document.getElementById('customStripBox');
      if (document.getElementById('stripPredef').checked) {
        predefBox.classList.remove('hidden');
        customBox.classList.add('hidden');
      } else {
        predefBox.classList.add('hidden');
        customBox.classList.remove('hidden');
      }
      renderStrip();
    }
    let selectedPattern = null;
    function selectPredefPattern(id) {
      document.getElementById('predefPattern1').classList.remove('selected');
      document.getElementById('predefPattern2').classList.remove('selected');
      if (id === 'pattern1') {
        document.getElementById('predefPattern1').classList.add('selected');
        selectedPattern = 'pattern1';
      } else {
        document.getElementById('predefPattern2').classList.add('selected');
        selectedPattern = 'pattern2';
      }
      renderStrip();
    }
    let stampSelected = null;
    function selectPredefStamp(id) {
      document.getElementById('stamp0').style.borderColor = 'transparent';
      document.getElementById('stamp1').style.borderColor = 'transparent';
      document.getElementById('stamp2').style.borderColor = 'transparent';
      if (id === 'stamp0') {
        document.getElementById('stamp0').style.borderColor = '#2196f3';
        stampSelected = 'https://static.wixstatic.com/media/1cf87e_f7284a8ad6d1438c9e79eb3d0818890a~mv2.png';
      } else if (id === 'stamp1') {
        document.getElementById('stamp1').style.borderColor = '#2196f3';
        stampSelected = 'https://static.wixstatic.com/media/1cf87e_b902bf7ff01d45679dc1964eedc548d2~mv2.png';
      } else {
        document.getElementById('stamp2').style.borderColor = '#2196f3';
        stampSelected = 'https://static.wixstatic.com/media/1cf87e_4f9563aebb5d4391ab392f456c1f8c74~mv2.png';
      }
      renderStrip();
    }
    // Default: ensure new Stamp0 is selected on load
    (function(){
      try {
        document.getElementById('stampPredef').checked = true;
        selectPredefStamp('stamp0');
      } catch(e) {}
    })();
    let borderSelected = null;
    function selectPredefBorder(id) {
      document.getElementById('border0').style.borderColor = 'transparent';
      document.getElementById('border1').style.borderColor = 'transparent';
      document.getElementById('border2').style.borderColor = 'transparent';
      if (id === 'border0') {
        document.getElementById('border0').style.borderColor = '#2196f3';
        borderSelected = 'https://static.wixstatic.com/media/1cf87e_38adc779dcf74126b32459b591f7405d~mv2.png';
      } else if (id === 'border1') {
        document.getElementById('border1').style.borderColor = '#2196f3';
        borderSelected = 'https://static.wixstatic.com/media/1cf87e_f9c1f6035fd14a6c87eb72e797edb4e1~mv2.png';
      } else {
        document.getElementById('border2').style.borderColor = '#2196f3';
        borderSelected = 'https://static.wixstatic.com/media/1cf87e_c9af8c73f3dc4513bcae356276cc9809~mv2.png';
      }
      renderStrip();
    }
    function togglePrubezna2(isYes) {
      document.getElementById('pbSlevaBox').style.display = isYes ? 'block' : 'none';
      renderStrip();
    }
    // Default: ensure new Border0 is selected on load
    (function(){
      try {
        document.getElementById('borderPredef').checked = true;
        selectPredefBorder('border0');
      } catch(e) {}
    })();
    async function renderStrip() {
      currentStripBlob = null;
      const canvas = document.getElementById('stripCanvas');
      const ctx    = canvas.getContext('2d');
      canvas.width  = 624;
      canvas.height = 246;
      ctx.clearRect(0, 0, 624, 246);
      const isPredef = document.getElementById('stripPredef').checked;
      const isCustom = document.getElementById('stripCustom').checked;
      if (isPredef) {
        if (!selectedPattern) {
          selectedPattern = 'pattern1';
        }
        const bgHex = document.getElementById('bgColor').value || '#000000';
        const bgA   = +document.getElementById('bgAlpha').value || 0;
        ctx.fillStyle = hexToRgba(bgHex, bgA / 100);
        ctx.fillRect(0, 0, 624, 246);
        const ovHex = document.getElementById('overlayColor').value || '#ffffff';
        const ovA   = +document.getElementById('overlayAlpha').value || 100;
        const patternUrl = 'https://static.wixstatic.com/media/1cf87e_dc47ca91c0c849bda67a6d65a9a0445b~mv2.png';
        try {
          const patImg = await loadImage(patternUrl);
          const tinted = tintPatternBlend(patImg, ovHex, 624, 246, ovA);
          ctx.drawImage(tinted, 0, 0);
        } catch (e) {}
      }
      else if (isCustom) {
        const f = document.getElementById('stripFile').files && document.getElementById('stripFile').files[0];
        if (!f) {
          document.getElementById('stripUrl').textContent = '(Zat√≠m ≈æ√°dn√Ω vlastn√≠ strip nahr√°n)';
          return;
        }
        try {
          const blobUrl = URL.createObjectURL(f);
          const cimg    = await loadImage(blobUrl);
          ctx.drawImage(cimg, 0, 0, 624, 246);
        } catch(e) {}
      }
      else {
        document.getElementById('stripUrl').textContent = '(Nebyla vybr√°na ≈æ√°dn√° varianta stripu)';
        return;
      }
      if (document.getElementById('card-razitka').classList.contains('selected')) {
        const n         = +document.getElementById('stampCount').value || 10;
        const fillCount = +document.getElementById('stampFilled').value || 0;
        document.getElementById('stampVal').textContent = `${fillCount} / ${n}`;
        if (n > 0) {
          await drawStampGrid(ctx, n, fillCount, 624, 246);
        }
      }
      if (document.getElementById('showStripTextChk').checked) {
        const val  = document.getElementById('stripTextVal').value || '';
        const col  = document.getElementById('stripTextColor').value || '#000';
        const size = +document.getElementById('stripTextSize').value || 25;
        const bold = document.getElementById('stripTextBold').checked;
        const posX = +document.getElementById('stripTextPosX').value || 0;
        const posY = +document.getElementById('stripTextPosY').value || 0;
        ctx.save();
        ctx.font         = (bold ? 'bold ' : '') + size + 'px sans-serif';
        ctx.fillStyle    = col;
        ctx.textAlign    = 'center';
        ctx.textBaseline = 'bottom';
        const x = canvas.width / 2 + posX;
        const y = canvas.height - 10 - posY;
        ctx.fillText(val, x, y);
        ctx.restore();
      }
      canvas.toBlob((blob) => {
        if (!blob) return;
        currentStripBlob = blob;
        const shortUrl = URL.createObjectURL(blob);
        document.getElementById('stripUrl').textContent = shortUrl;
        const linkView = document.getElementById('stripView');
        linkView.href  = shortUrl;
        linkView.style.display = 'inline-block';
        document.getElementById('stripDownload').style.display = 'inline-block';
        const preview = document.getElementById('stripResultImg');
        preview.style.display = 'block';
        preview.src = shortUrl;
      }, 'image/png');
    }
    async function drawStampGrid(ctx, n, filled, W, H) {
      const row1Count = Math.ceil(n / 2);
      const row2Count = n - row1Count;
      const offx = +document.getElementById('stampOffsetX').value || 0;
      const offy = +document.getElementById('stampOffsetY').value || 0;
      const gap  = +document.getElementById('stampGap').value || 10;
      const {
        stampImg, stampColor, stampAlpha, stampSize,
        stampStrokeOn, stampStrokeColor, stampStrokeSize, stampStrokeAlpha
      } = await getStampParams();
      const {
        borderImg, borderColor, borderAlpha, borderSize,
        borderStrokeOn, borderStrokeColor, borderStrokeSize, borderStrokeAlpha
      } = await getBorderParams();
      const fill1 = filled > row1Count ? row1Count : filled;
      drawOneRow(ctx, row1Count, 0, W, H, offx, offy, stampSize, borderSize, gap,
                 stampImg, stampColor, stampAlpha,
                 stampStrokeOn, stampStrokeColor, stampStrokeSize, stampStrokeAlpha,
                 borderImg, borderColor, borderAlpha,
                 borderStrokeOn, borderStrokeColor, borderStrokeSize, borderStrokeAlpha,
                 fill1);
      const secondFill = filled - row1Count;
      if (row2Count > 0) {
        const fill2 = secondFill > 0 ? secondFill : 0;
        drawOneRow(ctx, row2Count, 1, W, H, offx, offy, stampSize, borderSize, gap,
                   stampImg, stampColor, stampAlpha,
                   stampStrokeOn, stampStrokeColor, stampStrokeSize, stampStrokeAlpha,
                   borderImg, borderColor, borderAlpha,
                   borderStrokeOn, borderStrokeColor, borderStrokeSize, borderStrokeAlpha,
                   fill2);
      }
      if (document.getElementById('pbYes').checked) {
        const idx = +document.getElementById('pbIndex').value || 5;
        if (idx > 0 && idx <= n) {
          let row = 0; 
          let col = 0;
          if (idx <= row1Count) {
            row = 0; col = idx - 1;
          } else {
            row = 1; col = idx - 1 - row1Count;
          }
          const slotSize = Math.max(stampSize, borderSize);
          const rowCount = (row === 0 ? row1Count : row2Count);
          const rowWidth = rowCount * (slotSize + gap) - gap;
          const offsetX  = (W - rowWidth) / 2 + offx;
          const offsetY  = (H / 2) - (slotSize + gap) + offy;
          const baseY    = offsetY + row * (slotSize + gap);
          const x = offsetX + col * (slotSize + gap);
          const y = baseY;
          if (document.getElementById('pbTypeText').checked) {
            const txt   = document.getElementById('pbTextVal').value || '50%';
            const fsize = +document.getElementById('pbTextSize').value || 20;
            const tcol  = document.getElementById('pbTextColor').value || '#000000';
            const txOfs = +document.getElementById('pbTextOffsetX').value || 0;
            const tyOfs = +document.getElementById('pbTextOffsetY').value || 0;
            ctx.save();
            ctx.font      = fsize + 'px sans-serif';
            ctx.fillStyle = tcol;
            const cx = x + slotSize / 2 + txOfs;
            const cy = y + slotSize / 2 + tyOfs;
            const tw = ctx.measureText(txt).width;
            ctx.fillText(txt, cx - tw / 2, cy + (fsize / 2));
            ctx.restore();
          }
          else {
            const pf = document.getElementById('pbFile').files[0];
            if (pf) {
              const s  = +document.getElementById('pbImgSize').value || 40;
              const dx = +document.getElementById('pbImgOffsetX').value || 0;
              const dy = +document.getElementById('pbImgOffsetY').value || 0;
              try {
                const purl = URL.createObjectURL(pf);
                const pimg = await loadImage(purl);
                const cx   = x + slotSize / 2 + dx;
                const cy   = y + slotSize / 2 + dy;
                ctx.drawImage(pimg, cx - (s/2), cy - (s/2), s, s);
              } catch(e) {}
            }
          }
        }
      }
    }
    function drawOneRow(ctx, count, rowIndex, W, H, offx, offy, stampSize, borderSize, gap,
                        stampImg, stampColor, stampAlpha,
                        stampStrokeOn, stampStrokeColor, stampStrokeSize, stampStrokeAlpha,
                        borderImg, borderColor, borderAlpha,
                        borderStrokeOn, borderStrokeColor, borderStrokeSize, borderStrokeAlpha,
                        fillCount) {
      if (count <= 0) return;
      const slotSize = Math.max(stampSize, borderSize);
      const rowWidth = count * (slotSize + gap) - gap;
      const offsetX  = (W - rowWidth) / 2 + offx;
      const offsetY  = (H / 2) - (slotSize + gap) + offy;
      const baseY    = offsetY + rowIndex * (slotSize + gap);
      for (let i = 0; i < count; i++) {
        const x = offsetX + i * (slotSize + gap);
        const y = baseY;
        if (borderImg) {
          const tintedB = tintPatternBlend(borderImg, borderColor, borderSize, borderSize, borderAlpha);
          ctx.drawImage(tintedB, x + (slotSize - borderSize) / 2, y + (slotSize - borderSize) / 2);
          if (borderStrokeOn) {
            const bcx = x + (slotSize - borderSize) / 2;
            const bcy = y + (slotSize - borderSize) / 2;
            ctx.save();
            ctx.globalAlpha = borderStrokeAlpha / 100;
            ctx.strokeStyle = borderStrokeColor;
            ctx.lineWidth   = +borderStrokeSize || 2;
            ctx.beginPath();
            ctx.rect(bcx, bcy, borderSize, borderSize);
            ctx.stroke();
            ctx.restore();
          }
        }
        if (i < fillCount && stampImg) {
          const tintedS = tintPatternBlend(stampImg, stampColor, stampSize, stampSize, stampAlpha);
          const sx = x + (slotSize - stampSize) / 2;
          const sy = y + (slotSize - stampSize) / 2;
          ctx.drawImage(tintedS, sx, sy);
          if (stampStrokeOn) {
            ctx.save();
            ctx.globalAlpha = stampStrokeAlpha / 100;
            ctx.strokeStyle = stampStrokeColor;
            ctx.lineWidth   = +stampStrokeSize || 2;
            ctx.beginPath();
            ctx.rect(sx, sy, stampSize, stampSize);
            ctx.stroke();
            ctx.restore();
          }
        }
      }
    }
    async function getStampParams() {
      let stampImg   = null;
      let stampColor = '#ffffff';
      let stampAlpha = 0;
      let stampSize  = +document.getElementById('stampSize').value || 100;
      const stampStrokeOn    = document.getElementById('stampStrokeOn').checked;
      const stampStrokeColor = document.getElementById('stampStrokeColor').value || '#000000';
      const stampStrokeSize  = +document.getElementById('stampStrokeSize').value || 2;
      const stampStrokeAlpha = +document.getElementById('stampStrokeAlpha').value || 100;
      const isPredef = document.getElementById('stampPredef').checked;
      const isCustom = document.getElementById('stampCustom').checked;
      if (!isPredef && !isCustom) {
        stampSelected = 'https://static.wixstatic.com/media/1cf87e_f7284a8ad6d1438c9e79eb3d0818890a~mv2.png';
        document.getElementById('stampPredef').checked = true;
      }
      if (document.getElementById('stampPredef').checked) {
        if (!stampSelected) {
          stampSelected = 'https://static.wixstatic.com/media/1cf87e_f7284a8ad6d1438c9e79eb3d0818890a~mv2.png';
        }
        stampImg   = await loadImage(stampSelected);
        stampColor = document.getElementById('stampColor').value || '#ffffff';
        stampAlpha = +document.getElementById('stampAlpha').value || 0;
      }
      else if (document.getElementById('stampCustom').checked) {
        const f = document.getElementById('stampFile').files && document.getElementById('stampFile').files[0];
        if (f) {
          stampImg   = await loadImage(URL.createObjectURL(f));
          stampColor = document.getElementById('stampColor2').value || '#ffffff';
          stampAlpha = +document.getElementById('stampAlpha2').value || 0;
        }
      }
      return {
        stampImg, stampColor, stampAlpha, stampSize,
        stampStrokeOn, stampStrokeColor, stampStrokeSize, stampStrokeAlpha
      };
    }
    async function getBorderParams() {
      let borderImg   = null;
      let borderColor = '#ffffff';
      let borderAlpha = 0;
      let borderSize  = +document.getElementById('borderSize').value || 80;
      const borderStrokeOn    = document.getElementById('borderStrokeOn').checked;
      const borderStrokeColor = document.getElementById('borderStrokeColor').value || '#000000';
      const borderStrokeSize  = +document.getElementById('borderStrokeSize').value || 2;
      const borderStrokeAlpha = +document.getElementById('borderStrokeAlpha').value || 100;
      const borderEnabledEl = document.getElementById('borderEnabled');
      const borderEnabled = borderEnabledEl ? borderEnabledEl.checked : false;
      if (!borderEnabled) {
        return {
          borderImg: null,
          borderColor,
          borderAlpha,
          borderSize: 0,
          borderStrokeOn: false,
          borderStrokeColor,
          borderStrokeSize,
          borderStrokeAlpha
        };
      }
      const isBPredef = document.getElementById('borderPredef').checked;
      const isBCustom = document.getElementById('borderCustom').checked;
      if (!isBPredef && !isBCustom) {
        borderSelected = 'https://static.wixstatic.com/media/1cf87e_38adc779dcf74126b32459b591f7405d~mv2.png';
        document.getElementById('borderPredef').checked = true;
      }
      if (document.getElementById('borderPredef').checked) {
        if (!borderSelected) {
          borderSelected = 'https://static.wixstatic.com/media/1cf87e_38adc779dcf74126b32459b591f7405d~mv2.png';
        }
        borderImg   = await loadImage(borderSelected);
        borderColor = document.getElementById('borderColor').value || '#ffffff';
        borderAlpha = +document.getElementById('borderAlpha').value || 0;
      }
      else if (document.getElementById('borderCustom').checked) {
        const bf = document.getElementById('borderFile').files && document.getElementById('borderFile').files[0];
        if (bf) {
          borderImg   = await loadImage(URL.createObjectURL(bf));
          borderColor = document.getElementById('borderColor2').value || '#ffffff';
          borderAlpha = +document.getElementById('borderAlpha2').value || 0;
        }
      }
      return {
        borderImg, borderColor, borderAlpha, borderSize,
        borderStrokeOn, borderStrokeColor, borderStrokeSize, borderStrokeAlpha
      };
    }
    function tintPatternBlend(img, overlayColor, w, h, alphaPct) {
      const off = document.createElement('canvas');
      off.width  = w;
      off.height = h;
      const octx = off.getContext('2d');
      octx.drawImage(img, 0, 0, w, h);
      if (alphaPct > 0) {
        octx.globalAlpha = alphaPct / 100;
        octx.globalCompositeOperation = 'source-atop';
        octx.fillStyle = overlayColor;
        octx.fillRect(0, 0, w, h);
      }
      octx.globalAlpha = 1.0;
      octx.globalCompositeOperation = 'source-over';
      return off;
    }
    function loadImage(url) {
      return new Promise((resolve, reject) => {
        const i = new Image();
        i.crossOrigin = 'Anonymous';
        i.onload  = () => resolve(i);
        i.onerror = e => reject(e);
        i.src = url;
      });
    }
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
    function downloadStrip() {
      if (!currentStripBlob) {
        alert('Nejd≈ô√≠ve vygenerujte strip, ne≈æ ho budete stahovat.');
        return;
      }
      const a = document.createElement('a');
      a.href = URL.createObjectURL(currentStripBlob);
      a.download = 'strip.png';
      a.click();
    }
    // --- NOV√â FUNKCE PRO VYTV√Å≈òEN√ç KARTY a ODES√çL√ÅN√ç DAT DO FIREBASE ---
    // Inicializace Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD3xCNBnyirGVKiynoCQW3UTKZQCDea0P8",
      authDomain: "vernostkarty.firebaseapp.com",
      projectId: "vernostkarty",
      storageBucket: "vernostkarty-db.firebasestorage.app",
      messagingSenderId: "450728233627",
      appId: "1:450728233627:web:8d517b1f12de6462a8943e",
      measurementId: "G-TGWEGK01JL"
    };
    // Inicializace Firebase pomoc√≠ kompatibilitn√≠ch skript≈Ø
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const storage = firebase.storage();
    // Glob√°ln√≠ promƒõnn√© pro podnik
    let savedBusinessName = '';
    let businessID = '';
    let cardID = '';
    // --- Branch location helpers ---
    function showBranchPanel(show=true) {
      const p = document.getElementById('branchLocationPanel');
      if (p) p.style.display = show ? 'block' : 'none';
    }
    function updateBranchDisplays(address, lat, lng, placeId, osmType, osmId) {
      const addrRes = document.getElementById('branchAddressResult');
      const coordsEl = document.getElementById('branchCoordsDisplay');
      const addrNorm = document.getElementById('branchAddressNormalized');
      const latEl = document.getElementById('branchLat');
      const lngEl = document.getElementById('branchLng');
      const pidEl = document.getElementById('branchPlaceId');
      const otEl = document.getElementById('branchOsmType');
      const oidEl = document.getElementById('branchOsmId');
      if (addrRes) addrRes.textContent = address ? `Nalezen√° adresa: ${address}` : '';
      if (coordsEl) coordsEl.textContent = (lat && lng) ? `Sou≈ôadnice: ${lat}, ${lng}` : '';
      if (addrNorm) addrNorm.value = address || '';
      if (latEl) latEl.value = lat || '';
      if (lngEl) lngEl.value = lng || '';
      if (pidEl) pidEl.value = placeId || '';
      if (otEl) otEl.value = osmType || '';
      if (oidEl) oidEl.value = osmId || '';
      // aktualizuj n√°hled sbƒõru dat
      const collectBtn = document.getElementById('collectData');
      if (collectBtn) collectBtn.click();
    }
    async function geocodeBranchAddress() {
      try {
        const input = document.getElementById('branchAddressInput');
        const q = (input?.value || '').trim();
        if (!q) {
          alert('Zadejte pros√≠m adresu podniku.');
          return;
        }
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}`;
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const arr = await resp.json();
        if (!Array.isArray(arr) || arr.length === 0) {
          alert('Adresa nebyla nalezena. Zkuste up≈ôesnit zad√°n√≠.');
          return;
        }
        const best = arr[0];
        updateBranchDisplays(best.display_name || q, best.lat, best.lon, best.place_id?.toString?.(), best.osm_type || '', best.osm_id?.toString?.());
        // zobraz formul√°≈ô (pokud byl skryt√Ω)
        const form = document.getElementById('branchLocationForm');
        if (form) form.style.display = 'block';
      } catch (e) {
        console.error('Geocoding error:', e);
        alert('Do≈°lo k chybƒõ p≈ôi hled√°n√≠ adresy.');
      }
    }
    async function reverseGeocode(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`;
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const j = await resp.json();
        const display = j.display_name || `${lat}, ${lng}`;
        updateBranchDisplays(display, lat, lng, j.place_id?.toString?.(), j.osm_type || '', j.osm_id?.toString?.());
        const form = document.getElementById('branchLocationForm');
        if (form) form.style.display = 'block';
      } catch (e) {
        console.error('Reverse geocoding error:', e);
        updateBranchDisplays('', lat, lng, '', '', '');
      }
    }
    function setupBranchLocationUI() {
      const prompt = document.getElementById('branchLocationPrompt');
      const form = document.getElementById('branchLocationForm');
      const geocodeBtn = document.getElementById('branchGeocodeBtn');
      const useLocBtn = document.getElementById('branchUseLocationBtn');
      if (prompt) {
        prompt.onclick = () => {
          if (form) form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
        };
      }
      if (geocodeBtn) geocodeBtn.onclick = geocodeBranchAddress;
      if (useLocBtn) {
        useLocBtn.onclick = () => {
          if (!navigator.geolocation) {
            alert('V√°≈° prohl√≠≈æeƒç nepodporuje zji≈°tƒõn√≠ polohy.');
            return;
          }
          navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords;
            reverseGeocode(latitude, longitude);
          }, err => {
            console.error('Geolocation error:', err);
            alert('Nepoda≈ôilo se z√≠skat va≈°i polohu.');
          }, { enableHighAccuracy: true, timeout: 10000 });
        };
      }
    }

    async function saveBusinessName() {
      const name = document.getElementById('businessNameInput').value.trim();
      if (!name) {
        alert("Pros√≠m zadejte n√°zev podniku! üòä");
        return;
      }
      savedBusinessName = name;
      if (!businessID) {
        businessID = generateUniqueID(8);
      }
      // persist business data
      try {
        const res = await fetch('https://us-central1-vernostkarty-db.cloudfunctions.net/updateUserData', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:fullId,data:{businessName:savedBusinessName,businessID}})});
        if (!res.ok) console.error('Error updateUserData:', res.status, res.statusText);
      } catch (e) {
        console.error('Error saving business data:', e);
      }
      const bizDisplay = document.getElementById('businessInfoDisplay');
      bizDisplay.textContent = 'ID kav√°rny: ' + businessID;
      bizDisplay.style.display = 'block';
      alert("N√°zev podniku byl nastaven! üöÄ");
    }
    async function createCardID() {
      if(!savedBusinessName) {
        alert("Nejd≈ô√≠ve nastavte n√°zev va≈°eho podniku! üè¢");
        return;
      }
      if (cardID) {
        alert('Unik√°tn√≠ ID karty ji≈æ existuje: ' + cardID);
        return;
      }
      cardID = generateUniqueID(12);
      document.getElementById('cardIDDisplay').textContent = "Unik√°tn√≠ ID karty: " + cardID;
      const customerUrl = "https://onlineloyaltycards.com/cafe/?id=" + fullId.slice(-12);
      document.getElementById('customerUrlDisplay').textContent = "Va≈°e URL pro va≈°e z√°kazn√≠ky ke sta≈æen√≠ karty: " + customerUrl;
      updateQRCode();
      document.getElementById('qrCodeSection').style.display = 'block';
      document.getElementById('createCardIDBtn').style.display = 'none';
      const wixInd = document.getElementById('wixIdIndicator');
      if (wixInd) wixInd.textContent = 'ID karty: ' + cardID;
      // persist cardID
      try {
        const res = await fetch('https://us-central1-vernostkarty-db.cloudfunctions.net/updateUserData', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: fullId, data:{cardID}})});
        if (!res.ok) console.error('updateUserData cardID:', res.status);
      } catch(e) { console.error('Persist cardID error:', e); }
      // zobraz panel pro adresu poboƒçky a p≈ôiprav UI
      showBranchPanel(true);
      setupBranchLocationUI();
      alert("ID karty bylo √∫spƒõ≈°nƒõ vytvo≈ôeno! üöÄ");
    }
    // --- FUNKCE PRO QR K√ìD ---
    function updateQRCode() {
      var qrContainer = document.getElementById('qrCodeContainer');
      qrContainer.innerHTML = "";
      var customQRInput = document.getElementById('customQRCodeFile');
      if(customQRInput.files && customQRInput.files[0]) {
        var file = customQRInput.files[0];
        var customImg = new Image();
        customImg.onload = function() {
          if(document.getElementById('qrLogoFile').files && document.getElementById('qrLogoFile').files[0]) {
            var logoFile = document.getElementById('qrLogoFile').files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
              var logoImg = new Image();
              logoImg.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = customImg.width;
                canvas.height = customImg.height;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(customImg, 0, 0);
                var logoSize = canvas.width * 0.2;
                var x = (canvas.width - logoSize) / 2;
                var y = (canvas.height - logoSize) / 2;
                ctx.drawImage(logoImg, x, y, logoSize, logoSize);
                qrContainer.innerHTML = "";
                qrContainer.appendChild(canvas);
              }
              logoImg.src = e.target.result;
            }
            reader.readAsDataURL(logoFile);
          } else {
            customImg.style.width = "200px";
            customImg.style.height = "200px";
            qrContainer.appendChild(customImg);
          }
        }
        customImg.src = URL.createObjectURL(file);
        return;
      }
      var customerUrl = document.getElementById('customerUrlDisplay').textContent.replace("Va≈°e URL pro va≈°e z√°kazn√≠ky ke sta≈æen√≠ karty: ", "");
      if(!customerUrl) {
        customerUrl = "https://onlineloyaltycards.com";
      }
      var qrColor = document.getElementById('qrColor').value;
      var qrBgColor = document.getElementById('qrBgColor').value;
      new QRCode(qrContainer, {
        text: customerUrl,
        width: 200,
        height: 200,
        colorDark: qrColor,
        colorLight: qrBgColor,
        correctLevel: QRCode.CorrectLevel.H
      });
      if(document.getElementById('qrLogoFile').files && document.getElementById('qrLogoFile').files[0]) {
        var file = document.getElementById('qrLogoFile').files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
          var logoImg = new Image();
          logoImg.onload = function() {
             var canvas = qrContainer.querySelector('canvas');
             if(canvas) {
               var ctx = canvas.getContext('2d');
               var logoSize = canvas.width * 0.2;
               var x = (canvas.width - logoSize) / 2;
               var y = (canvas.height - logoSize) / 2;
               ctx.drawImage(logoImg, x, y, logoSize, logoSize);
             }
          }
          logoImg.src = e.target.result;
        }
        reader.readAsDataURL(file);
      }
    }
    function downloadQRCode() {
      var qrContainer = document.getElementById('qrCodeContainer');
      var canvas = qrContainer.querySelector('canvas');
      if(canvas) {
        var link = document.createElement('a');
        link.href = canvas.toDataURL("image/png");
        link.download = "qrcode.png";
        link.click();
      } else {
        var img = qrContainer.querySelector('img');
        if(img) {
          var link = document.createElement('a');
          link.href = img.src;
          link.download = "qrcode.png";
          link.click();
        } else {
          alert("QR k√≥d nen√≠ k dispozici ke sta≈æen√≠.");
        }
      }
    }
    // --- NOV√Å FUNKCE: ODESL√ÅN√ç DAT DO FIREBASE ---
    async function sendDataToFirebase() {
      const btn = document.getElementById('sendToFirebaseBtn');
      btn.disabled = true;
      btn.textContent = "Odes√≠l√°m...";
      
      const cardIDText = document.getElementById('cardIDDisplay').textContent;
      if (!cardIDText) {
        alert('Nejd≈ô√≠ve vytvo≈ôte ID karty! üöß');
        btn.disabled = false;
        btn.textContent = 'Poslat do Firebase üöÄ';
        return;
      }
      const cardID = cardIDText.replace('ID karty: ', '');
      
      // Sbƒõr ne‚Äëfile dat
      const data = {};
      document.querySelectorAll('input:not([type="file"]), textarea, select').forEach(f => {
        const key = f.id || f.name;
        if (!key || key === 'cardType' || f.type === 'file') return;
        let val = '';
        if (f.type === 'checkbox' || f.type === 'radio') {
          if (f.checked) val = f.value || 'on';
        } else {
          val = f.value;
        }
        data[key] = val;
      });
      document.querySelectorAll('img[id]').forEach(img => data[img.id] = img.src);
      document.querySelectorAll('canvas[id]').forEach(c => data[c.id] = c.toDataURL());
      data.cardID = cardID;
      data.timestamp = new Date().toISOString();
      // record selected card type
      const sel = document.querySelector('.card.selected');
      if (sel) data.cardType = sel.id;

      // -- Validace a hashov√°n√≠ hesla pro obsluhu --
      const password = data.staffPassword;
      const passwordConfirm = data.staffPasswordConfirm;

      if (password || passwordConfirm) { // Zpracujeme heslo, jen pokud je zad√°no
          if (!validatePasswords(true)) { // Pou≈æijeme existuj√≠c√≠ validaci
              btn.disabled = false;
              btn.textContent = 'Poslat do Firebase üöÄ';
              return; // P≈ôeru≈°√≠me odesl√°n√≠, pokud hesla nesouhlas√≠
          }

          // Pokud je v≈°e v po≈ô√°dku, zahashujeme heslo
          const staffPasswordHash = await hashPassword(password);
          data.staffPasswordHash = staffPasswordHash; // P≈ôid√°me hash do dat k odesl√°n√≠
      }

      // Sma≈æeme p≈Øvodn√≠ textov√° hesla z dat, aby se neodeslala do Firebase
      delete data.staffPassword;
      delete data.staffPasswordConfirm;
      // -- Konec validace a hashov√°n√≠ --
      
      // Ulo≈æen√≠ ne‚Äëfile dat do Firestore
      try {
        const res = await fetch('https://us-central1-vernostkarty-db.cloudfunctions.net/updateUserData', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: cardID, data })
        });
        const j = await res.json();
        let resultEl = document.getElementById('resultFirebase');
        if (!resultEl) {
          resultEl = document.createElement('p');
          resultEl.id = 'resultFirebase';
          resultEl.style.marginTop = '20px';
          resultEl.style.fontWeight = 'bold';
          document.getElementById('sendToFirebaseBtn').parentNode.insertBefore(resultEl, document.getElementById('sendToFirebaseBtn').nextSibling);
        }
        resultEl.textContent = j.success ? '√öspƒõ≈°nƒõ odesl√°no!' : 'Chyba: ' + j.error;
      } catch (error) {
        console.error('Chyba p≈ôi z√°pisu dokumentu:', error);
        alert('Chyba p≈ôi odes√≠l√°n√≠ dat do Firebase üò¢');
        btn.disabled = false;
        btn.textContent = 'Poslat do Firebase üöÄ';
        return;
      }
      
      // Nahr√°n√≠ soubor≈Ø do Storage ve slo≈æce businessID/cardID
      const bizText = document.getElementById('businessInfoDisplay')?.textContent.trim() || '';
      const businessID = bizText.split('ID kav√°rny: ')[1] || '';
      const fileInputs = ['logoFile','stripFile','stampFile','borderFile','customQRCodeFile','pbFile'];
      const uploadPromises = fileInputs.map(id => {
        const inp = document.getElementById(id);
        return (inp?.files?.[0])
          ? firebase.storage().ref(`${businessID}/${cardID}/${id.replace(/File$/, '')}.${inp.files[0].name.split('.').pop().toLowerCase()}`).put(inp.files[0])
          : Promise.resolve();
      });
      const stripCanvas = document.getElementById('stripCanvas');
      if (stripCanvas) {
        uploadPromises.push(new Promise(resolve => {
          stripCanvas.toBlob(blob => {
            if (!blob) return resolve();
            firebase.storage().ref(`${businessID}/${cardID}/finalStrip.png`)
              .put(blob)
              .then(() => resolve());
          });
        }));
      }
      // Vygenerovat PNG z loga (text nebo obr√°zek) zachov√°vaj√≠c√≠ okraje
      uploadPromises.push(new Promise(resolve => {
        html2canvas(document.getElementById('logoSlot'), { backgroundColor: null })
          .then(canvas => {
            canvas.toBlob(blob => {
              if (!blob) return resolve();
              const ref = firebase.storage().ref(`${businessID}/${cardID}/logo.png`);
              ref.put(blob)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                  console.log('Logo URL:', url);
                  let urlEl = document.getElementById('logoUrl');
                  if (!urlEl) {
                    urlEl = document.createElement('p');
                    urlEl.id = 'logoUrl';
                    urlEl.style.marginTop = '10px';
                    document.getElementById('sendToFirebaseBtn').parentNode.appendChild(urlEl);
                  }
                  urlEl.textContent = url;
                  resolve();
                })
                .catch(() => resolve());
            });
          })
          .catch(() => resolve());
      }));
      await Promise.all(uploadPromises);
      
      const imgResEl = document.getElementById('resultImages');
      if (imgResEl) imgResEl.textContent = 'Obr√°zky √∫spƒõ≈°nƒõ nahr√°ny';
      
      btn.disabled = false;
      btn.textContent = 'Poslat do Firebase üöÄ';
    }
    // --- FUNKCE PRO generov√°n√≠ unik√°tn√≠ho ID ---
    function generateUniqueID(length) {
      var result = '';
      var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var charactersLength = characters.length;
      for ( var i = 0; i < length; i++ ) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      return result;
    }
    // Pro uk√°zku: schov√°me jm√©no na √∫vod
    document.getElementById('customerInfo').style.display = 'none';
  </script>

  <script>
    document.getElementById('sendToFirebaseFromCollect').addEventListener('click', async () => {
      // determine doc id: prefer fullId, fallback to cardID
      const id = fullId || cardID;
      if (!id) return alert('Nev√≠m, jak√© je ID karty‚Ä¶');
      fullId = id;
      const lines = document.getElementById('result').textContent.split('\n').filter(l => l);
      const data = {};
      lines.forEach(l => { const idx = l.indexOf(':'); if (idx > 0) data[l.slice(0, idx).trim()] = l.slice(idx+1).trim(); });
      data.businessName = document.getElementById('businessNameInput').value.trim();
      data.businessID = document.getElementById('businessInfoDisplay').textContent.replace('ID kav√°rny: ', '').trim();
      data.customerUrl = document.getElementById('customerUrlDisplay').textContent.replace('Va≈°e URL pro va≈°e z√°kazn√≠ky ke sta≈æen√≠ karty: ', '');
      const sel = document.querySelector('.card.selected');
      if (sel) data.cardType = sel.id;

      // Zpracov√°n√≠ a form√°tov√°n√≠ dat o slevov√Ωch √∫rovn√≠ch podle pravidel (v≈ædy 3 √∫rovnƒõ, fallbacky, form√°tov√°n√≠ z≈Østatku)
      let statuses = [], slevy = [], zustatky = [];
      for (let i = 1; i <= 3; i++) {
        statuses.push(data[`status${i}`] || '');
        slevy.push(data[`sleva${i}`] || '');
        // Ukl√°dej v≈ædy pouze ƒç√≠slo bez prefixu
        let rawZustatek = data[`zustatek${i}`] || '';
        if (typeof rawZustatek === 'string' && rawZustatek.startsWith('0 a≈æ ')) {
          rawZustatek = rawZustatek.replace(/^0 a≈æ /, '');
        }
        zustatky.push(rawZustatek);
      }
      for (let i = 0; i < 3; i++) {
        if (!statuses[i]) statuses[i] = statuses[i-1] || statuses[0] || '';
        if (!slevy[i]) slevy[i] = slevy[i-1] || slevy[0] || '';
        if (!zustatky[i]) zustatky[i] = zustatky[i-1] || zustatky[0] || '';
      }
      data.level1_status = statuses[0];
      data.level1_sleva = slevy[0];
      data.level1_zustatek = zustatky[0];
      data.level2_status = statuses[1];
      data.level2_sleva = slevy[1];
      data.level2_zustatek = zustatky[1];
      data.level3_status = statuses[2];
      data.level3_sleva = slevy[2];
      data.level3_zustatek = zustatky[2];
      // sma≈æ p≈Øvodn√≠ surov√° pole
      for (let i = 1; i <= 3; i++) {
        delete data[`status${i}`];
        delete data[`sleva${i}`];
        delete data[`zustatek${i}`];
      }
      
      // upload files to Storage
      const fileInputs = ['logoFile','stripFile','stampFile','borderFile','customQRCodeFile','pbFile'];
      for (let key of fileInputs) {
        const inputEl = document.getElementById(key);
        if (inputEl?.files?.[0]) {
          const file = inputEl.files[0];
          const ext = file.name.split('.').pop().toLowerCase();
          const ref = firebase.storage().ref(`cardzapier/${fullId}/${key.replace(/File$/, '')}.${ext}`);
          const snap = await ref.put(file);
          const url = await snap.ref.getDownloadURL();
          document.getElementById('uploadStatus').innerHTML += `<strong>${key}</strong>: <a href="${url}" target="_blank">${url}</a><br/>`;
        }
      }
      // upload strip z canvasu
      const stripCanvas = document.getElementById('stripCanvas');
      if (stripCanvas) {
        const blob = await new Promise(resolve => stripCanvas.toBlob(resolve));
        if (blob) {
          const refStrip = firebase.storage().ref(`cardzapier/${fullId}/strip.png`);
          const snapStrip = await refStrip.put(blob);
          const urlStrip = await snapStrip.ref.getDownloadURL();
          document.getElementById('uploadStatus').innerHTML += `<strong>strip</strong>: <a href="${urlStrip}" target="_blank">${urlStrip}</a><br/>`;
        }
      }
      // upload logo slot as PNG
      const logoSlotCanvas = await html2canvas(document.getElementById('logoSlot'), { backgroundColor: null });
      const logoBlob = await new Promise(resolve => logoSlotCanvas.toBlob(resolve));
      if (logoBlob) {
        const refLogo = firebase.storage().ref(`cardzapier/${fullId}/logo.png`);
        const snapLogo = await refLogo.put(logoBlob);
        const urlLogo = await snapLogo.ref.getDownloadURL();
        document.getElementById('uploadStatus').innerHTML += `<strong>logo</strong>: <a href="${urlLogo}" target="_blank">${urlLogo}</a><br/>`;
      }
      // -- Validace a hashov√°n√≠ hesla p≈ôed odesl√°n√≠m --
      const password = document.getElementById('staffPassword').value;
      const passwordConfirm = document.getElementById('staffPasswordConfirm').value;
      const passwordErrorDiv = document.getElementById('passwordError');
      let staffPasswordHash = null;

      // Heslo je voliteln√©, ale pokud je zad√°no, mus√≠ b√Ωt validn√≠
      if (password || passwordConfirm) {
          if (password.length < 8) {
              passwordErrorDiv.textContent = 'Heslo mus√≠ m√≠t alespo≈à 8 znak≈Ø.';
              alert('Heslo pro obsluhu nespl≈àuje po≈æadavky.');
              return; // Zastav√≠ odes√≠l√°n√≠
          }
          if (password !== passwordConfirm) {
              passwordErrorDiv.textContent = 'Hesla se neshoduj√≠.';
              alert('Hesla pro obsluhu se neshoduj√≠.');
              return; // Zastav√≠ odes√≠l√°n√≠
          }
          // Pokud je v≈°e v po≈ô√°dku, zahashujeme heslo
          staffPasswordHash = await hashPassword(password);
          data.staffPasswordHash = staffPasswordHash; // P≈ôid√°me hash do dat k odesl√°n√≠

          // Sma≈æeme p≈Øvodn√≠ textov√° hesla z dat, aby se neodeslala do Firebase
          delete data.staffPassword;
          delete data.staffPasswordConfirm;
      }
      // -- Konec validace a hashov√°n√≠ --

      // send collected data to Firestore
      try {
        const res = await fetch('https://us-central1-vernostkarty-db.cloudfunctions.net/updateUserData', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, data })
        });
        const j = await res.json();
        let resultEl = document.getElementById('resultFirebase');
        if (!resultEl) {
          resultEl = document.createElement('p');
          resultEl.id = 'resultFirebase';
          resultEl.style.marginTop = '20px';
          resultEl.style.fontWeight = 'bold';
          document.getElementById('sendToFirebaseFromCollect').parentNode.insertBefore(resultEl, document.getElementById('sendToFirebaseFromCollect').nextSibling);
        }
        resultEl.textContent = j.success ? '√öspƒõ≈°nƒõ odesl√°no!' : 'Chyba: ' + j.error;
      } catch (error) {
        console.error('Chyba p≈ôi z√°pisu dokumentu:', error);
        let resultEl = document.getElementById('resultFirebase');
        if (!resultEl) {
          resultEl = document.createElement('p');
          resultEl.id = 'resultFirebase';
          resultEl.style.marginTop = '20px';
          resultEl.style.fontWeight = 'bold';
          document.getElementById('sendToFirebaseFromCollect').parentNode.insertBefore(resultEl, document.getElementById('sendToFirebaseFromCollect').nextSibling);
        }
        resultEl.textContent = 'Komunikaƒçn√≠ chyba.';
      }
      document.getElementById('uploadStatus').innerHTML += 'Hotovo.';
    });

    // --- Funkce pro heslo obsluhy ---
    function toggleStaffPasswordVisibility(fieldId, icon) {
      const field = document.getElementById(fieldId);
      if (field.type === 'password') {
        field.type = 'text';
        icon.textContent = 'üôà';
      } else {
        field.type = 'password';
        icon.textContent = 'üëÅÔ∏è';
      }
    }

    // Asynchronn√≠ funkce pro hashov√°n√≠ hesla
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer)); // p≈ôevod na pole bajt≈Ø
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); // p≈ôevod na hex string
      return hashHex;
    }

    // Validace hesel p≈ôi psan√≠
    const passInput = document.getElementById('staffPassword');
    const confirmPassInput = document.getElementById('staffPasswordConfirm');
    const errorDiv = document.getElementById('passwordError');

    function validatePasswords() {
        errorDiv.textContent = ''; // Reset chybov√© hl√°≈°ky
        if (passInput.value && confirmPassInput.value) { // Kontrolujeme jen kdy≈æ jsou obƒõ pole vyplnƒõna
            if (passInput.value.length < 8) {
                errorDiv.textContent = 'Heslo mus√≠ m√≠t alespo≈à 8 znak≈Ø.';
                return false;
            }
            if (passInput.value !== confirmPassInput.value) {
                errorDiv.textContent = 'Hesla se neshoduj√≠.';
                return false;
            }
        }
        return true;
    }

    passInput.addEventListener('input', validatePasswords);
    confirmPassInput.addEventListener('input', validatePasswords);
  </script>
  <!-- Spr√°va √∫ƒçtu a p≈ôi≈ôazen√≠ certifik√°tu -->
  <div style="
    background: #fff;
    border: 2px solid #4CAF50;
    border-radius: 8px;
    padding: 20px;
    margin: 20px auto;
    width: 320px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  ">
    <h3 style="color: #4CAF50; margin-bottom: 15px;">Spr√°va √∫ƒçtu</h3>
    <p style="margin-bottom: 15px; color: #666;">Kliknut√≠m na tlaƒç√≠tko p≈ôi≈ôad√≠te certifik√°t k va≈°emu √∫ƒçtu</p>
    <button id="generateAccountBtn" style="
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s;
    " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">Vygenerovat √∫ƒçet</button>
    <div id="accountResult" style="margin-top: 15px; font-weight: bold;"></div>
  </div>

  <script>
    // Funkce pro vygenerov√°n√≠ √∫ƒçtu
    document.getElementById('generateAccountBtn').addEventListener('click', async function() {
      const resultDiv = document.getElementById('accountResult');
      resultDiv.innerHTML = 'Generuji √∫ƒçet...';
      resultDiv.style.color = 'blue';
      
      try {
        // Z√≠sk√°n√≠ fullId z aktu√°ln√≠ho dokumentu (36 znak≈Ø)
        const fullId = getCurrentFullId();
        if (!fullId) {
          throw new Error('Nepoda≈ôilo se z√≠skat fullId z dokumentu');
        }
        
        console.log('Pou≈æ√≠v√°m fullId:', fullId);
        
        // Vol√°n√≠ funkce pro p≈ôi≈ôazen√≠ certifik√°tu
        const result = await assignCertificateToAccount(fullId);
        
        if (result.success) {
          resultDiv.innerHTML = `
            <div style="color: green;">
              ‚úÖ √öƒçet √∫spƒõ≈°nƒõ vygenerov√°n!<br>
              P≈ôi≈ôazen certifik√°t: ${result.certificateName}<br>
              Cesty ulo≈æeny do Firebase
            </div>
          `;
        } else {
          throw new Error(result.error || 'Nezn√°m√° chyba');
        }
        
      } catch (error) {
        console.error('Chyba p≈ôi generov√°n√≠ √∫ƒçtu:', error);
        resultDiv.innerHTML = `<div style="color: red;">‚ùå Chyba: ${error.message}</div>`;
      }
    });
    
    // Funkce pro z√≠sk√°n√≠ fullId z aktu√°ln√≠ho dokumentu
    function getCurrentFullId() {
      // Pokus√≠me se naj√≠t fullId v r≈Øzn√Ωch m√≠stech dokumentu
      
      // 1. Z URL parametr≈Ø
      const urlParams = new URLSearchParams(window.location.search);
      let fullId = urlParams.get('id') || urlParams.get('fullId');
      
      // 2. Z localStorage (pokud je tam ulo≈æeno)
      if (!fullId) {
        fullId = localStorage.getItem('currentFullId');
      }
      
      // 3. Z glob√°ln√≠ promƒõnn√© (pokud existuje)
      if (!fullId && typeof window.currentFullId !== 'undefined') {
        fullId = window.currentFullId;
      }
      
      // 4. Z BroadcastChannel fullId (pokud je dostupn√©)
      if (!fullId && typeof window.currentFullId !== 'undefined' && window.currentFullId) {
        fullId = window.currentFullId;
        console.log('üì° Pou≈æito fullId z BroadcastChannel:', fullId);
      }
      
      // 5. POZOR: Nepou≈æ√≠vat generateUUID() - mus√≠me pou≈æ√≠t existuj√≠c√≠ WIX user ID!
      if (!fullId) {
        console.error('‚ö†Ô∏è CHYBA: Nepoda≈ôilo se z√≠skat fullId! Mus√≠ b√Ωt p≈ôed√°no z WIX syst√©mu.');
        alert('Chyba: Nepoda≈ôilo se z√≠skat ID u≈æivatele. Pros√≠m obnovte str√°nku a zkuste to znovu.');
        return null;
      }
      
      // Ovƒõ≈ôen√≠ form√°tu (36 znak≈Ø s pomlƒçkami)
      if (fullId && fullId.length === 36 && fullId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
        // Ulo≈æ√≠me platn√© fullId do localStorage pro p≈ô√≠≈°t√≠ pou≈æit√≠
        localStorage.setItem('currentFullId', fullId);
        console.log('Pou≈æ√≠v√°m existuj√≠c√≠ fullId:', fullId);
        return fullId;
      }
      
      console.error('‚ö†Ô∏è CHYBA: Neplatn√Ω form√°t fullId:', fullId);
      return null;
    }
    
    // Funkce pro generov√°n√≠ UUID
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    
    // Hlavn√≠ funkce pro p≈ôi≈ôazen√≠ certifik√°tu k √∫ƒçtu
    async function assignCertificateToAccount(fullId) {
      try {
        // Vol√°n√≠ Cloud Function pro p≈ôi≈ôazen√≠ certifik√°tu
        const response = await fetch('https://us-central1-vernostkarty-db.cloudfunctions.net/assignCertificate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fullId })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        return result;
        
      } catch (error) {
        console.error('Chyba p≈ôi vol√°n√≠ assignCertificate:', error);
        return {
          success: false,
          error: error.message
        };
      }
    }
  </script>
</body>
</html>
